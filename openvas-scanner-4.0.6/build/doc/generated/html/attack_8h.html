<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OpenVAS Scanner: src/attack.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_1c445093eb429e71cff849a5afa0a294.html">src</a>
  </div>
</div>
<div class="contents">
<h1>attack.h File Reference</h1><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dynsection">
</div>

<p><a href="attack_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="attack_8h.html#a8487544e41baa26d15e4f9a91e4b34b8">attack_network</a> (struct arglist *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Attack a whole network.  <a href="#a8487544e41baa26d15e4f9a91e4b34b8"></a><br/></td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a8487544e41baa26d15e4f9a91e4b34b8"></a><!-- doxytag: member="attack.h::attack_network" ref="a8487544e41baa26d15e4f9a91e4b34b8" args="(struct arglist *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void attack_network </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Attack a whole network. </p>

<p>Definition at line <a class="el" href="attack_8c_source.html#l01145">1145</a> of file <a class="el" href="attack_8c_source.html">attack.c</a>.</p>

<p>References <a class="el" href="attack_8c_source.html#l01145">attack_network()</a>, <a class="el" href="processes_8c_source.html#l00075">create_process()</a>, <a class="el" href="attack_8c_source.html#l00084">attack_start_args::fqdn</a>, <a class="el" href="attack_8c_source.html#l00915">free_uploaded_file()</a>, <a class="el" href="utils_8c_source.html#l00156">get_max_checks_number()</a>, <a class="el" href="utils_8c_source.html#l00125">get_max_hosts_number()</a>, <a class="el" href="attack_8c_source.html#l00079">attack_start_args::globals</a>, <a class="el" href="attack_8c_source.html#l00081">attack_start_args::host_mac_addr</a>, <a class="el" href="attack_8c_source.html#l00080">attack_start_args::hostip</a>, <a class="el" href="hosts_8c_source.html#l00204">hosts_init()</a>, <a class="el" href="hosts_8c_source.html#l00213">hosts_new()</a>, <a class="el" href="hosts_8c_source.html#l00433">hosts_read()</a>, <a class="el" href="hosts_8c_source.html#l00242">hosts_set_pid()</a>, <a class="el" href="log_8c_source.html#l00147">log_write()</a>, <a class="el" href="attack_8c_source.html#l00071">MAX_FORK_RETRIES</a>, <a class="el" href="pluginscheduler_8c_source.html#l00773">plugins_scheduler_free()</a>, <a class="el" href="pluginscheduler_8c_source.html#l00502">plugins_scheduler_init()</a>, <a class="el" href="preferences_8c_source.html#l00406">preferences_get_bool()</a>, <a class="el" href="preferences_8c_source.html#l00425">preferences_get_string()</a>, <a class="el" href="attack_8c_source.html#l00082">attack_start_args::sched</a>, and <a class="el" href="attack_8c_source.html#l00083">attack_start_args::thread_socket</a>.</p>

<p>Referenced by <a class="el" href="attack_8c_source.html#l01145">attack_network()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01146"></a>01146 {
<a name="l01147"></a>01147   <span class="keywordtype">int</span> max_hosts = 0, max_checks;
<a name="l01148"></a>01148   <span class="keywordtype">int</span> num_tested = 0;
<a name="l01149"></a>01149   <span class="keywordtype">char</span> *hostlist;
<a name="l01150"></a>01150   openvas_hosts_t *hosts, *hosts_allow, *hosts_deny;
<a name="l01151"></a>01151   openvas_hosts_t *sys_hosts_allow, *sys_hosts_deny;
<a name="l01152"></a>01152   openvas_host_t *<a class="code" href="structhost.html" title="Host information, implemented as doubly linked list.">host</a>;
<a name="l01153"></a>01153   <span class="keywordtype">int</span> global_socket = -1;
<a name="l01154"></a>01154   <span class="keyword">struct </span>arglist *preferences = NULL;
<a name="l01155"></a>01155   <span class="keyword">struct </span>arglist *plugins = NULL;
<a name="l01156"></a>01156   <a class="code" href="structplugins__scheduler__struct.html">plugins_scheduler_t</a> sched;
<a name="l01157"></a>01157   <span class="keywordtype">int</span> fork_retries = 0;
<a name="l01158"></a>01158   GHashTable *files;
<a name="l01159"></a>01159   <span class="keyword">struct </span>timeval then, now;
<a name="l01160"></a>01160   <span class="keywordtype">char</span> buffer[INET6_ADDRSTRLEN];
<a name="l01161"></a>01161 
<a name="l01162"></a>01162   <span class="keywordtype">int</span> network_phase = 0;
<a name="l01163"></a>01163   gchar *network_targets, *port_range;
<a name="l01164"></a>01164   <span class="keywordtype">int</span> do_network_scan = 0;
<a name="l01165"></a>01165   <span class="keywordtype">int</span> scan_stopped;
<a name="l01166"></a>01166 
<a name="l01167"></a>01167   gettimeofday (&amp;then, NULL);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169   preferences = arg_get_value (globals, <span class="stringliteral">&quot;preferences&quot;</span>);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171   <span class="keywordflow">if</span> ((do_network_scan = <a class="code" href="preferences_8c.html#a6596c98ca1c1d8872b7dc4d346bf1f64" title="Get a integer boolean value of a &amp;quot;yes&amp;quot;/&amp;quot;no&amp;quot; preference.">preferences_get_bool</a> (preferences, <span class="stringliteral">&quot;network_scan&quot;</span>)) == -1)
<a name="l01172"></a>01172     do_network_scan = 0;
<a name="l01173"></a>01173   network_targets = arg_get_value (preferences, <span class="stringliteral">&quot;network_targets&quot;</span>);
<a name="l01174"></a>01174   <span class="keywordflow">if</span> (network_targets != NULL)
<a name="l01175"></a>01175     arg_add_value (globals, <span class="stringliteral">&quot;network_targets&quot;</span>, ARG_STRING,
<a name="l01176"></a>01176                    strlen (network_targets), network_targets);
<a name="l01177"></a>01177   <span class="keywordflow">if</span> (do_network_scan)
<a name="l01178"></a>01178     {
<a name="l01179"></a>01179       gchar *network_scan_status = arg_get_value (globals, <span class="stringliteral">&quot;network_scan_status&quot;</span>);
<a name="l01180"></a>01180       <span class="keywordflow">if</span> (network_scan_status != NULL)
<a name="l01181"></a>01181         <span class="keywordflow">if</span> (g_ascii_strcasecmp (network_scan_status, <span class="stringliteral">&quot;done&quot;</span>) == 0)
<a name="l01182"></a>01182           network_phase = 0;
<a name="l01183"></a>01183         <span class="keywordflow">else</span>
<a name="l01184"></a>01184           network_phase = 1;
<a name="l01185"></a>01185       <span class="keywordflow">else</span>
<a name="l01186"></a>01186         {
<a name="l01187"></a>01187           arg_add_value (globals, <span class="stringliteral">&quot;network_scan_status&quot;</span>, ARG_STRING,
<a name="l01188"></a>01188                          strlen (<span class="stringliteral">&quot;busy&quot;</span>), <span class="stringliteral">&quot;busy&quot;</span>);
<a name="l01189"></a>01189           network_phase = 1;
<a name="l01190"></a>01190         }
<a name="l01191"></a>01191     }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193   num_tested = 0;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195   global_socket = GPOINTER_TO_SIZE (arg_get_value (globals, <span class="stringliteral">&quot;global_socket&quot;</span>));
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   plugins = arg_get_value (globals, <span class="stringliteral">&quot;plugins&quot;</span>);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199   <span class="comment">/* Init and check Target List */</span>
<a name="l01200"></a>01200   hostlist = arg_get_value (preferences, <span class="stringliteral">&quot;TARGET&quot;</span>);
<a name="l01201"></a>01201   <span class="keywordflow">if</span> (hostlist == NULL)
<a name="l01202"></a>01202     {
<a name="l01203"></a>01203       error_message_to_client (globals, <span class="stringliteral">&quot;Missing target hosts&quot;</span>, NULL, NULL);
<a name="l01204"></a>01204       <span class="keywordflow">return</span>;
<a name="l01205"></a>01205     }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207   <span class="comment">/* Verify the port range is a valid one */</span>
<a name="l01208"></a>01208   port_range = arg_get_value (preferences, <span class="stringliteral">&quot;port_range&quot;</span>);
<a name="l01209"></a>01209   <span class="keywordflow">if</span> (validate_port_range (port_range))
<a name="l01210"></a>01210     {
<a name="l01211"></a>01211       error_message_to_client (globals, <span class="stringliteral">&quot;Invalid port range&quot;</span>, NULL, port_range);
<a name="l01212"></a>01212       <span class="keywordflow">return</span>;
<a name="l01213"></a>01213     }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215   <span class="comment">/* Initialize the attack. */</span>
<a name="l01216"></a>01216   sched = <a class="code" href="pluginscheduler_8c.html#a8e1b9ab914996adb316670f3df838604">plugins_scheduler_init</a> (plugins,
<a name="l01217"></a>01217     <a class="code" href="preferences_8c.html#a6596c98ca1c1d8872b7dc4d346bf1f64" title="Get a integer boolean value of a &amp;quot;yes&amp;quot;/&amp;quot;no&amp;quot; preference.">preferences_get_bool</a> (preferences, <span class="stringliteral">&quot;auto_enable_dependencies&quot;</span>) == 1 ? 1 : 0,
<a name="l01218"></a>01218     network_phase);
<a name="l01219"></a>01219 
<a name="l01220"></a>01220   max_hosts = <a class="code" href="utils_8c.html#aa6c665de3bb692d0b05be8aefd1a8aed">get_max_hosts_number</a> (preferences);
<a name="l01221"></a>01221   max_checks = <a class="code" href="utils_8c.html#a90c92ffdbb1ca875dc47d79165a46a4e">get_max_checks_number</a> (preferences);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223   <span class="keywordflow">if</span> (network_phase)
<a name="l01224"></a>01224     {
<a name="l01225"></a>01225       network_targets = arg_get_value (preferences, <span class="stringliteral">&quot;network_targets&quot;</span>);
<a name="l01226"></a>01226       <span class="keywordflow">if</span> (network_targets == NULL)
<a name="l01227"></a>01227         {
<a name="l01228"></a>01228           <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;WARNING: In network phase, but without targets! Stopping.\n&quot;</span>);
<a name="l01229"></a>01229           host = NULL;
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231       <span class="keywordflow">else</span>
<a name="l01232"></a>01232         {
<a name="l01233"></a>01233           <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a>
<a name="l01234"></a>01234             (<span class="stringliteral">&quot;Start a new scan. Target(s) : %s, in network phase with target %s\n&quot;</span>,
<a name="l01235"></a>01235              hostlist, network_targets);
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238   <span class="keywordflow">else</span>
<a name="l01239"></a>01239     {
<a name="l01240"></a>01240       <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Starts a new scan. Target(s) : %s, with max_hosts = %d and&quot;</span>
<a name="l01241"></a>01241                  <span class="stringliteral">&quot; max_checks = %d\n&quot;</span>, hostlist, max_hosts, max_checks);
<a name="l01242"></a>01242     }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244   hosts = openvas_hosts_new (hostlist);
<a name="l01245"></a>01245   <span class="comment">/* Apply Hosts preferences. */</span>
<a name="l01246"></a>01246   apply_hosts_preferences (hosts, preferences);
<a name="l01247"></a>01247 
<a name="l01248"></a>01248   <span class="comment">/* Don&apos;t start if the provided interface is unauthorized. */</span>
<a name="l01249"></a>01249   <span class="keywordflow">if</span> (apply_source_iface_preference (globals, preferences) != 0)
<a name="l01250"></a>01250     {
<a name="l01251"></a>01251       openvas_hosts_free (hosts);
<a name="l01252"></a>01252       error_message_to_client (globals, <span class="stringliteral">&quot;Interface not authorized for scanning&quot;</span>, NULL, NULL);
<a name="l01253"></a>01253       <span class="keywordflow">return</span>;
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255   <span class="comment">/* hosts_allow/deny lists. */</span>
<a name="l01256"></a>01256   hosts_allow = openvas_hosts_new (<a class="code" href="preferences_8c.html#a513e01049edeead12882471090f84efc">preferences_get_string</a>
<a name="l01257"></a>01257                                     (preferences, <span class="stringliteral">&quot;hosts_allow&quot;</span>));
<a name="l01258"></a>01258   hosts_deny = openvas_hosts_new (<a class="code" href="preferences_8c.html#a513e01049edeead12882471090f84efc">preferences_get_string</a>
<a name="l01259"></a>01259                                    (preferences, <span class="stringliteral">&quot;hosts_deny&quot;</span>));
<a name="l01260"></a>01260   <span class="comment">/* sys_* preferences, which can&apos;t be overriden by the client. */</span>
<a name="l01261"></a>01261   sys_hosts_allow = openvas_hosts_new (<a class="code" href="preferences_8c.html#a513e01049edeead12882471090f84efc">preferences_get_string</a>
<a name="l01262"></a>01262                                         (preferences, <span class="stringliteral">&quot;sys_hosts_allow&quot;</span>));
<a name="l01263"></a>01263   sys_hosts_deny = openvas_hosts_new (<a class="code" href="preferences_8c.html#a513e01049edeead12882471090f84efc">preferences_get_string</a>
<a name="l01264"></a>01264                                        (preferences, <span class="stringliteral">&quot;sys_hosts_deny&quot;</span>));
<a name="l01265"></a>01265   host = openvas_hosts_next (hosts);
<a name="l01266"></a>01266   <span class="keywordflow">if</span> (host == NULL)
<a name="l01267"></a>01267     <span class="keywordflow">goto</span> stop;
<a name="l01268"></a>01268   <a class="code" href="hosts_8c.html#a7413f12d00b4b8ca23573d3ab195cf32">hosts_init</a> (global_socket, max_hosts);
<a name="l01269"></a>01269   <span class="comment">/*</span>
<a name="l01270"></a>01270 <span class="comment">   * Start the attack !</span>
<a name="l01271"></a>01271 <span class="comment">   */</span>
<a name="l01272"></a>01272   <span class="keywordflow">while</span> (host)
<a name="l01273"></a>01273     {
<a name="l01274"></a>01274       <span class="keywordtype">int</span> pid;
<a name="l01275"></a>01275       <span class="keywordtype">char</span> *hostname;
<a name="l01276"></a>01276       <span class="keyword">struct </span>in6_addr host_ip;
<a name="l01277"></a>01277 
<a name="l01278"></a>01278       hostname = openvas_host_value_str (host);
<a name="l01279"></a>01279       <span class="keywordflow">if</span> (openvas_host_get_addr6 (host, &amp;host_ip) == -1)
<a name="l01280"></a>01280         {
<a name="l01281"></a>01281           <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Couldn&apos;t resolve target %s\n&quot;</span>, hostname);
<a name="l01282"></a>01282           error_message_to_client (globals, <span class="stringliteral">&quot;Couldn&apos;t resolve hostname.&quot;</span>,
<a name="l01283"></a>01283                                    hostname, NULL);
<a name="l01284"></a>01284           g_free (hostname);
<a name="l01285"></a>01285           host = openvas_hosts_next (hosts);
<a name="l01286"></a>01286           <span class="keywordflow">continue</span>;
<a name="l01287"></a>01287         }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289       <span class="comment">/* Do we have the right to test this host ? */</span>
<a name="l01290"></a>01290       <span class="keywordflow">if</span> (!host_authorized (host, &amp;host_ip, hosts_allow, hosts_deny))
<a name="l01291"></a>01291         {
<a name="l01292"></a>01292           error_message_to_client (globals, <span class="stringliteral">&quot;Host access denied.&quot;</span>,
<a name="l01293"></a>01293                                    hostname, NULL);
<a name="l01294"></a>01294           <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Host %s access denied.&quot;</span>, hostname);
<a name="l01295"></a>01295         }
<a name="l01296"></a>01296       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!host_authorized (host, &amp;host_ip, sys_hosts_allow,
<a name="l01297"></a>01297                                  sys_hosts_deny))
<a name="l01298"></a>01298         {
<a name="l01299"></a>01299           error_message_to_client (globals, <span class="stringliteral">&quot;Host access denied&quot;</span>
<a name="l01300"></a>01300                                             <span class="stringliteral">&quot; (system-wide restriction.)&quot;</span>,
<a name="l01301"></a>01301                                    hostname, NULL);
<a name="l01302"></a>01302           <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Host %s access denied (sys_* preference restriction.)&quot;</span>,
<a name="l01303"></a>01303                      hostname);
<a name="l01304"></a>01304         }
<a name="l01305"></a>01305       <span class="keywordflow">else</span>
<a name="l01306"></a>01306         {
<a name="l01307"></a>01307           <span class="keyword">struct </span><a class="code" href="structattack__start__args.html">attack_start_args</a> args;
<a name="l01308"></a>01308           <span class="keywordtype">int</span> s;
<a name="l01309"></a>01309           <span class="keywordtype">char</span> *MAC = NULL;
<a name="l01310"></a>01310           <span class="keywordtype">int</span> mac_err = -1;
<a name="l01311"></a>01311           gchar *name;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313           <span class="keywordflow">if</span> (<a class="code" href="preferences_8c.html#a6596c98ca1c1d8872b7dc4d346bf1f64" title="Get a integer boolean value of a &amp;quot;yes&amp;quot;/&amp;quot;no&amp;quot; preference.">preferences_get_bool</a> (preferences, <span class="stringliteral">&quot;use_mac_addr&quot;</span>) &gt; 0
<a name="l01314"></a>01314               &amp;&amp; v6_is_local_ip (&amp;host_ip))
<a name="l01315"></a>01315             {
<a name="l01316"></a>01316               mac_err = v6_get_mac_addr (&amp;host_ip, &amp;MAC);
<a name="l01317"></a>01317               <span class="keywordflow">if</span> (mac_err &gt; 0)
<a name="l01318"></a>01318                 {
<a name="l01319"></a>01319                   <span class="comment">/* remote host is down */</span>
<a name="l01320"></a>01320                   g_free (hostname);
<a name="l01321"></a>01321                   host = openvas_hosts_next (hosts);
<a name="l01322"></a>01322                   <span class="keywordflow">continue</span>;
<a name="l01323"></a>01323                 }
<a name="l01324"></a>01324             }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326           s = <a class="code" href="hosts_8c.html#a6e08b50d1588bf6e1ab7b12e07ad5bca">hosts_new</a> (<a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>, hostname);
<a name="l01327"></a>01327           <span class="keywordflow">if</span> (s &lt; 0)
<a name="l01328"></a>01328             <span class="keywordflow">goto</span> scan_stop;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330           args.globals = <a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>;
<a name="l01331"></a>01331           memcpy (&amp;args.hostip, &amp;host_ip, sizeof (<span class="keyword">struct</span> in6_addr));
<a name="l01332"></a>01332           name = openvas_host_value_str (host);
<a name="l01333"></a>01333           strncpy (args.fqdn, name, sizeof (args.fqdn));
<a name="l01334"></a>01334           g_free (name);
<a name="l01335"></a>01335           args.host_mac_addr = MAC;
<a name="l01336"></a>01336           args.sched = sched;
<a name="l01337"></a>01337           args.thread_socket = s;
<a name="l01338"></a>01338 
<a name="l01339"></a>01339         forkagain:
<a name="l01340"></a>01340           pid = <a class="code" href="processes_8c.html#ae77cd660c7151420e84d1a570d820088" title="Create a new process (fork).">create_process</a> ((<a class="code" href="processes_8h.html#af3520b6013b0dfd89d3a9f32f9ba9e55">process_func_t</a>) attack_start, &amp;args);
<a name="l01341"></a>01341           <span class="keywordflow">if</span> (pid &lt; 0)
<a name="l01342"></a>01342             {
<a name="l01343"></a>01343               fork_retries++;
<a name="l01344"></a>01344               <span class="keywordflow">if</span> (fork_retries &gt; <a class="code" href="attack_8c.html#a9edf21834eb9a3d957fe9b313519b406">MAX_FORK_RETRIES</a>)
<a name="l01345"></a>01345                 {
<a name="l01346"></a>01346                   <span class="comment">/* Forking failed - we go to the wait queue. */</span>
<a name="l01347"></a>01347                   <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;fork() failed - %s. %s won&apos;t be tested\n&quot;</span>,
<a name="l01348"></a>01348                              strerror (errno), hostname);
<a name="l01349"></a>01349                   efree (&amp;MAC);
<a name="l01350"></a>01350                   <span class="keywordflow">goto</span> stop;
<a name="l01351"></a>01351                 }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353               <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a>
<a name="l01354"></a>01354                 (<span class="stringliteral">&quot;fork() failed - sleeping %d seconds and trying again...\n&quot;</span>,
<a name="l01355"></a>01355                  fork_retries);
<a name="l01356"></a>01356               fork_sleep (fork_retries);
<a name="l01357"></a>01357               <span class="keywordflow">goto</span> forkagain;
<a name="l01358"></a>01358             }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360           <a class="code" href="hosts_8c.html#a96e234b46b5336ef5c238cb3d5c9cd96">hosts_set_pid</a> (hostname, pid);
<a name="l01361"></a>01361           <span class="keywordflow">if</span> (network_phase)
<a name="l01362"></a>01362             <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Testing %s (network level) [%d]\n&quot;</span>,
<a name="l01363"></a>01363                        network_targets, pid);
<a name="l01364"></a>01364           <span class="keywordflow">else</span>
<a name="l01365"></a>01365             <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Testing %s (%s) [%d]\n&quot;</span>,
<a name="l01366"></a>01366                        hostname, inet_ntop (AF_INET6,
<a name="l01367"></a>01367                                             &amp;args.hostip,
<a name="l01368"></a>01368                                             buffer,
<a name="l01369"></a>01369                                             sizeof (buffer)),
<a name="l01370"></a>01370                        pid);
<a name="l01371"></a>01371           <span class="keywordflow">if</span> (MAC != NULL)
<a name="l01372"></a>01372             efree (&amp;MAC);
<a name="l01373"></a>01373         }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375       num_tested++;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377       <span class="keywordflow">if</span> (network_phase)
<a name="l01378"></a>01378         {
<a name="l01379"></a>01379           host = NULL;
<a name="l01380"></a>01380           arg_set_value (<a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>, <span class="stringliteral">&quot;network_scan_status&quot;</span>, strlen (<span class="stringliteral">&quot;done&quot;</span>), <span class="stringliteral">&quot;done&quot;</span>);
<a name="l01381"></a>01381         }
<a name="l01382"></a>01382       <span class="keywordflow">else</span>
<a name="l01383"></a>01383         {
<a name="l01384"></a>01384           g_free (hostname);
<a name="l01385"></a>01385           host = openvas_hosts_next (hosts);
<a name="l01386"></a>01386         }
<a name="l01387"></a>01387     }
<a name="l01388"></a>01388 
<a name="l01389"></a>01389   <span class="comment">/* Every host is being tested... We have to wait for the processes</span>
<a name="l01390"></a>01390 <span class="comment">   * to terminate. */</span>
<a name="l01391"></a>01391   <span class="keywordflow">while</span> (<a class="code" href="hosts_8c.html#af5191588fd4d428e7b8dbd6c821cd979" title="Returns -1 if client asked to stop all tests or connection was lost or error. 0 otherwise...">hosts_read</a> (<a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>) == 0)
<a name="l01392"></a>01392     ;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394   <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Test complete&quot;</span>);
<a name="l01395"></a>01395 
<a name="l01396"></a>01396 scan_stop:
<a name="l01397"></a>01397   <span class="comment">/* Free the memory used by the files uploaded by the user, if any. */</span>
<a name="l01398"></a>01398   files = arg_get_value (<a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>, <span class="stringliteral">&quot;files_translation&quot;</span>);
<a name="l01399"></a>01399   <span class="keywordflow">if</span> (files)
<a name="l01400"></a>01400     g_hash_table_foreach_remove (files, (GHRFunc) <a class="code" href="attack_8c.html#aefc84c8b868e2d4534a725989ad98f27" title="Frees memory used by uploaded, as callback for.">free_uploaded_file</a>, NULL);
<a name="l01401"></a>01401 
<a name="l01402"></a>01402 stop:
<a name="l01403"></a>01403   scan_stopped = GPOINTER_TO_SIZE(arg_get_value (<a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>, <span class="stringliteral">&quot;stop_required&quot;</span>));
<a name="l01404"></a>01404 
<a name="l01405"></a>01405   openvas_hosts_free (hosts);
<a name="l01406"></a>01406   openvas_hosts_free (hosts_allow);
<a name="l01407"></a>01407   openvas_hosts_free (hosts_deny);
<a name="l01408"></a>01408   openvas_hosts_free (sys_hosts_allow);
<a name="l01409"></a>01409   openvas_hosts_free (sys_hosts_deny);
<a name="l01410"></a>01410 
<a name="l01411"></a>01411   <a class="code" href="pluginscheduler_8c.html#a7b0040d82a6963686b920e1932cf7209">plugins_scheduler_free</a> (sched);
<a name="l01412"></a>01412 
<a name="l01413"></a>01413   gettimeofday (&amp;now, NULL);
<a name="l01414"></a>01414   <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Total time to scan all hosts : %ld seconds\n&quot;</span>,
<a name="l01415"></a>01415              now.tv_sec - then.tv_sec);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417   <span class="keywordflow">if</span> (do_network_scan &amp;&amp; network_phase &amp;&amp; !scan_stopped)
<a name="l01418"></a>01418     <a class="code" href="attack_8c.html#aeaf06dc1c878dcca3b8f2019b8df0d94" title="Attack a whole network.">attack_network</a> (<a class="code" href="structattack__start__args.html#ae43b0aadc1b6c809a58b0b975fae2b90">globals</a>);
<a name="l01419"></a>01419 
<a name="l01420"></a>01420   <span class="keywordflow">return</span>;
<a name="l01421"></a>01421 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 23 Oct 2015 for OpenVAS Scanner by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
