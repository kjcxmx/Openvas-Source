<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OpenVAS Scanner: src/save_kb.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_1c445093eb429e71cff849a5afa0a294.html">src</a>
  </div>
</div>
<div class="contents">
<h1>save_kb.h File Reference</h1><code>#include &lt;openvas/misc/arglists.h&gt;</code><br/>
<div class="dynheader">
Include dependency graph for save_kb.h:</div>
<div class="dynsection">
</div>
<div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dynsection">
</div>

<p><a href="save__kb_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#a040936a210b4d0e3a67ffd14e4da912b">save_kb_new</a> (struct arglist *, char *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize a new KB that will be saved.  <a href="#a040936a210b4d0e3a67ffd14e4da912b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#a7efe64ab724785d02554ef8c92ee4b05">save_kb_close</a> (struct arglist *, char *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#a33b6df8ab3c347cda2b2be2ebdb883e4">save_kb_backup</a> (char *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Makes a copy of the knowledge base.  <a href="#a33b6df8ab3c347cda2b2be2ebdb883e4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#abd4579c550b96a4ad31892115d321f03">save_kb_restore_backup</a> (char *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Restores a copy of the knowledge base.  <a href="#abd4579c550b96a4ad31892115d321f03"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#ae6ef6f02804f7e7826ae2ba723450c78">save_kb_write_int</a> (struct arglist *, char *, char *, int)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#a4e5f053311a1d7e7a52c8207862bc195">save_kb_write_str</a> (struct arglist *, char *, char *, char *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#af9357aec0db0ac5d85d7e0d3a7e155e6">save_kb_exists</a> (char *)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">kb_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#a7287c4dab745a6674c05ef1418beac49">save_kb_load_kb</a> (struct arglist *, char *)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Restores a previously saved knowledge base.  <a href="#a7287c4dab745a6674c05ef1418beac49"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="save__kb_8h.html#a4081f248573f30b6fa0042b29515569b">save_kb</a> (struct arglist *)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a4081f248573f30b6fa0042b29515569b"></a><!-- doxytag: member="save_kb.h::save_kb" ref="a4081f248573f30b6fa0042b29515569b" args="(struct arglist *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname"> <em>globals</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="return"><dt><b>Returns:</b></dt><dd>1 if a network scan is in progress. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000010">Todo:</a></b></dt><dd>This operation is possibly executed often (with every kb modification). Evaluate wether the preference can change during a scan, consider the use of a static variable. </dd></dl>

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00740">740</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>Referenced by <a class="el" href="piic_8c_source.html#l00055">kb_parse()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00741"></a>00741 {
<a name="l00742"></a>00742   <span class="keywordtype">char</span> *value;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744   <span class="keywordflow">if</span> (!globals)
<a name="l00745"></a>00745     <span class="keywordflow">return</span> 0;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747   value = arg_get_value (globals, <span class="stringliteral">&quot;network_scan_status&quot;</span>);
<a name="l00748"></a>00748   <span class="keywordflow">if</span> (value &amp;&amp; !strcmp (value, <span class="stringliteral">&quot;busy&quot;</span>))
<a name="l00749"></a>00749     <span class="keywordflow">return</span> 1;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   <span class="keywordflow">return</span> 0;
<a name="l00752"></a>00752 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a33b6df8ab3c347cda2b2be2ebdb883e4"></a><!-- doxytag: member="save_kb.h::save_kb_backup" ref="a33b6df8ab3c347cda2b2be2ebdb883e4" args="(char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb_backup </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Makes a copy of the knowledge base. </p>

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00540">540</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>References <a class="el" href="locks_8c_source.html#l00066">file_lock()</a>, <a class="el" href="locks_8c_source.html#l00101">file_locked()</a>, <a class="el" href="locks_8c_source.html#l00089">file_unlock()</a>, and <a class="el" href="log_8c_source.html#l00147">log_write()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00541"></a>00541 {
<a name="l00542"></a>00542   <span class="keywordtype">char</span> *fname = kb_fname (hostname);
<a name="l00543"></a>00543   <span class="keywordtype">char</span> *newname = NULL;
<a name="l00544"></a>00544   <span class="keywordtype">int</span> fd_src = -1, fd_dst = -1;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="keywordflow">if</span> (<a class="code" href="locks_8c.html#ac9109c8213cd8478105ec4b5b56e9b1c">file_locked</a> (fname))
<a name="l00547"></a>00547     {
<a name="l00548"></a>00548       <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;%s is locked\n&quot;</span>, fname);
<a name="l00549"></a>00549       <span class="keywordflow">goto</span> failed1;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552   <a class="code" href="locks_8c.html#a40b41c04a5df1cc6c64c26b508166a5d">file_lock</a> (fname);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554   newname = emalloc (strlen (fname) + 5);
<a name="l00555"></a>00555   strcat (newname, fname);
<a name="l00556"></a>00556   strcat (newname, <span class="stringliteral">&quot;.bak&quot;</span>);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558   <span class="keywordflow">if</span> ((fd_src = open (fname, O_RDONLY)) &gt;= 0)
<a name="l00559"></a>00559     {
<a name="l00560"></a>00560       <span class="keywordtype">char</span> buf[4096];
<a name="l00561"></a>00561       <span class="keywordtype">int</span> n;
<a name="l00562"></a>00562       fd_dst = open (newname, O_WRONLY | O_CREAT | O_TRUNC, 0640);
<a name="l00563"></a>00563       <span class="keywordflow">if</span> (fd_dst &lt; 0)
<a name="l00564"></a>00564         {
<a name="l00565"></a>00565           <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;save_kb_backup failed : %s&quot;</span>, strerror (errno));
<a name="l00566"></a>00566           close (fd_src);
<a name="l00567"></a>00567           <span class="keywordflow">goto</span> failed;
<a name="l00568"></a>00568         }
<a name="l00569"></a>00569       bzero (buf, <span class="keyword">sizeof</span> (buf));
<a name="l00570"></a>00570       <span class="keywordflow">while</span> ((n = read (fd_src, buf, <span class="keyword">sizeof</span> (buf))) &gt; 0)
<a name="l00571"></a>00571         {
<a name="l00572"></a>00572           <span class="keywordtype">int</span> m = 0;
<a name="l00573"></a>00573           <span class="keywordflow">while</span> (m != n)
<a name="l00574"></a>00574             {
<a name="l00575"></a>00575               <span class="keywordtype">int</span> e = write (fd_dst, &amp;(buf[m]), n - m);
<a name="l00576"></a>00576               <span class="keywordflow">if</span> (e &lt; 0)
<a name="l00577"></a>00577                 {
<a name="l00578"></a>00578                   <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;save_kb_backup failed : %s&quot;</span>, strerror (errno));
<a name="l00579"></a>00579                   close (fd_src);
<a name="l00580"></a>00580                   close (fd_dst);
<a name="l00581"></a>00581                   <span class="keywordflow">goto</span> failed;
<a name="l00582"></a>00582                 }
<a name="l00583"></a>00583               m += e;
<a name="l00584"></a>00584             }
<a name="l00585"></a>00585           bzero (buf, <span class="keyword">sizeof</span> (buf));
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588   <span class="keywordflow">else</span>
<a name="l00589"></a>00589     <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;save_kb_backup failed : %s\n&quot;</span>, strerror (errno));
<a name="l00590"></a>00590 
<a name="l00591"></a>00591   close (fd_src);
<a name="l00592"></a>00592   close (fd_dst);
<a name="l00593"></a>00593   efree (&amp;newname);
<a name="l00594"></a>00594   <a class="code" href="locks_8c.html#a5237a98830f3ba49d14bc95b25f72ad2">file_unlock</a> (fname);
<a name="l00595"></a>00595   efree (&amp;fname);
<a name="l00596"></a>00596   <span class="keywordflow">return</span> 0;
<a name="l00597"></a>00597 failed:
<a name="l00598"></a>00598   <a class="code" href="locks_8c.html#a5237a98830f3ba49d14bc95b25f72ad2">file_unlock</a> (fname);
<a name="l00599"></a>00599 failed1:
<a name="l00600"></a>00600   efree (&amp;fname);
<a name="l00601"></a>00601   efree (&amp;newname);
<a name="l00602"></a>00602   <span class="keywordflow">return</span> -1;
<a name="l00603"></a>00603 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a7efe64ab724785d02554ef8c92ee4b05"></a><!-- doxytag: member="save_kb.h::save_kb_close" ref="a7efe64ab724785d02554ef8c92ee4b05" args="(struct arglist *, char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void save_kb_close </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00448">448</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>References <a class="el" href="locks_8c_source.html#l00089">file_unlock()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00449"></a>00449 {
<a name="l00450"></a>00450   <span class="keywordtype">int</span> fd = GPOINTER_TO_SIZE (arg_get_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>));
<a name="l00451"></a>00451   <span class="keywordtype">char</span> *fname = kb_fname (hostname);
<a name="l00452"></a>00452   <span class="keywordflow">if</span> (fd &gt; 0)
<a name="l00453"></a>00453     close (fd);
<a name="l00454"></a>00454   <a class="code" href="locks_8c.html#a5237a98830f3ba49d14bc95b25f72ad2">file_unlock</a> (fname);
<a name="l00455"></a>00455   efree (&amp;fname);
<a name="l00456"></a>00456 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="af9357aec0db0ac5d85d7e0d3a7e155e6"></a><!-- doxytag: member="save_kb.h::save_kb_exists" ref="af9357aec0db0ac5d85d7e0d3a7e155e6" args="(char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb_exists </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>hostname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="return"><dt><b>Returns:</b></dt><dd>1 if we already saved a KB for this <a class="el" href="structhost.html" title="Host information, implemented as doubly linked list.">host</a>, less than &lt;max_age&gt; seconds ago. If &lt;max_age&gt; equals zero, then the age is not taken in account (returns true if a knowledge base exists). </dd></dl>

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00464">464</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>References <a class="el" href="locks_8c_source.html#l00101">file_locked()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00465"></a>00465 {
<a name="l00466"></a>00466   <span class="keywordtype">char</span> *fname = kb_fname (hostname);
<a name="l00467"></a>00467   FILE *f;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469   <span class="keywordflow">if</span> (<a class="code" href="locks_8c.html#ac9109c8213cd8478105ec4b5b56e9b1c">file_locked</a> (fname))
<a name="l00470"></a>00470     {
<a name="l00471"></a>00471       efree (&amp;fname);
<a name="l00472"></a>00472       <span class="keywordflow">return</span> 0;
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474   f = fopen (fname, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00475"></a>00475   efree (&amp;fname);
<a name="l00476"></a>00476   <span class="keywordflow">if</span> (!f)
<a name="l00477"></a>00477     <span class="keywordflow">return</span> 0;
<a name="l00478"></a>00478   <span class="keywordflow">else</span>
<a name="l00479"></a>00479     {
<a name="l00480"></a>00480       fclose (f);
<a name="l00481"></a>00481       <span class="keywordflow">return</span> 1;
<a name="l00482"></a>00482     }
<a name="l00483"></a>00483 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a7287c4dab745a6674c05ef1418beac49"></a><!-- doxytag: member="save_kb.h::save_kb_load_kb" ref="a7287c4dab745a6674c05ef1418beac49" args="(struct arglist *, char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">kb_t save_kb_load_kb </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname"> <em>globals</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>hostname</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Restores a previously saved knowledge base. </p>
<p>The KB entry 'Host/dead' is ignored, as well as all the entries starting with '/tmp/'. </p>

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00613">613</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>References <a class="el" href="locks_8c_source.html#l00101">file_locked()</a>, and <a class="el" href="log_8c_source.html#l00147">log_write()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00614"></a>00614 {
<a name="l00615"></a>00615   <span class="keywordtype">char</span> *fname = kb_fname (hostname);
<a name="l00616"></a>00616   FILE *f;
<a name="l00617"></a>00617   <span class="keywordtype">int</span> fd;
<a name="l00618"></a>00618   kb_t kb;
<a name="l00619"></a>00619   <span class="keywordtype">char</span> buf[4096];
<a name="l00620"></a>00620   <span class="keywordtype">long</span> max_age = 864000;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <span class="keywordflow">if</span> (<a class="code" href="locks_8c.html#ac9109c8213cd8478105ec4b5b56e9b1c">file_locked</a> (fname))
<a name="l00623"></a>00623     {
<a name="l00624"></a>00624       efree (&amp;fname);
<a name="l00625"></a>00625       <span class="keywordflow">return</span> NULL;
<a name="l00626"></a>00626     }
<a name="l00627"></a>00627   f = fopen (fname, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00628"></a>00628   <span class="keywordflow">if</span> (!f)
<a name="l00629"></a>00629     {
<a name="l00630"></a>00630       <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Could not open %s - kb won&apos;t be restored for %s\n&quot;</span>,
<a name="l00631"></a>00631                  fname, hostname);
<a name="l00632"></a>00632       efree (&amp;fname);
<a name="l00633"></a>00633       <span class="keywordflow">return</span> NULL;
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635   bzero (buf, <span class="keyword">sizeof</span> (buf));
<a name="l00636"></a>00636   <span class="keywordflow">if</span> (fgets (buf, <span class="keyword">sizeof</span> (buf) - 1, f) == NULL)
<a name="l00637"></a>00637     {
<a name="l00638"></a>00638       <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Could not read %s - kb won&apos;t be restored for %s\n&quot;</span>,
<a name="l00639"></a>00639                  fname, hostname);
<a name="l00640"></a>00640       efree (&amp;fname);
<a name="l00641"></a>00641       fclose (f);
<a name="l00642"></a>00642       <span class="keywordflow">return</span> NULL;
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   kb = kb_new ();
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <span class="comment">/* Ignore the date */</span>
<a name="l00648"></a>00648   bzero (buf, <span class="keyword">sizeof</span> (buf));
<a name="l00649"></a>00649 
<a name="l00650"></a>00650   <span class="keywordflow">while</span> (fgets (buf, <span class="keyword">sizeof</span> (buf) - 1, f))
<a name="l00651"></a>00651     {
<a name="l00652"></a>00652       <span class="keywordtype">int</span> type;
<a name="l00653"></a>00653       <span class="keywordtype">char</span> *name, *value, *t;
<a name="l00654"></a>00654       <span class="keyword">struct </span>timeval then, now;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656       buf[strlen (buf) - 1] = <span class="charliteral">&apos;\0&apos;</span>;     <span class="comment">/* chomp(buf) */</span>
<a name="l00657"></a>00657       t = strchr (buf, <span class="charliteral">&apos; &apos;</span>);
<a name="l00658"></a>00658       <span class="keywordflow">if</span> (!t)
<a name="l00659"></a>00659         <span class="keywordflow">continue</span>;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661       t[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663       then.tv_sec = atol (buf);
<a name="l00664"></a>00664       t[0] = <span class="charliteral">&apos; &apos;</span>;
<a name="l00665"></a>00665       t++;
<a name="l00666"></a>00666       type = atoi (t);
<a name="l00667"></a>00667       t = strchr (t, <span class="charliteral">&apos; &apos;</span>);
<a name="l00668"></a>00668       <span class="keywordflow">if</span> (!t)
<a name="l00669"></a>00669         <span class="keywordflow">continue</span>;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671       t[0] = <span class="charliteral">&apos; &apos;</span>;
<a name="l00672"></a>00672       t++;
<a name="l00673"></a>00673       name = t;
<a name="l00674"></a>00674       t = strchr (name, <span class="charliteral">&apos;=&apos;</span>);
<a name="l00675"></a>00675       <span class="keywordflow">if</span> (!t)
<a name="l00676"></a>00676         <span class="keywordflow">continue</span>;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678       t[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00679"></a>00679       name = strdup (name);
<a name="l00680"></a>00680       t[0] = <span class="charliteral">&apos; &apos;</span>;
<a name="l00681"></a>00681       t++;
<a name="l00682"></a>00682       value = strdup (t);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684       <span class="keywordflow">if</span> (strcmp (name, <span class="stringliteral">&quot;Host/dead&quot;</span>) &amp;&amp; strncmp (name, <span class="stringliteral">&quot;/tmp/&quot;</span>, 4)
<a name="l00685"></a>00685           &amp;&amp; strcmp (name, <span class="stringliteral">&quot;Host/ping_failed&quot;</span>))
<a name="l00686"></a>00686         {
<a name="l00687"></a>00687           gettimeofday (&amp;now, NULL);
<a name="l00688"></a>00688           <span class="keywordflow">if</span> (now.tv_sec - then.tv_sec &gt; max_age)
<a name="l00689"></a>00689             {
<a name="l00690"></a>00690               <span class="comment">/*</span>
<a name="l00691"></a>00691 <span class="comment">                 log_write(&quot;discarding %s because it&apos;s too old\n&quot;,</span>
<a name="l00692"></a>00692 <span class="comment">                 name,</span>
<a name="l00693"></a>00693 <span class="comment">                 (now.tv_sec - then.tv_sec));</span>
<a name="l00694"></a>00694 <span class="comment">               */</span>
<a name="l00695"></a>00695             }
<a name="l00696"></a>00696           <span class="keywordflow">else</span>
<a name="l00697"></a>00697             {
<a name="l00698"></a>00698               <span class="keywordflow">if</span> (type == ARG_STRING)
<a name="l00699"></a>00699                 {
<a name="l00700"></a>00700                   <span class="keywordtype">char</span> *tmp = rmslashes (value);
<a name="l00701"></a>00701                   kb_item_add_str (kb, name, tmp);
<a name="l00702"></a>00702                   efree (&amp;tmp);
<a name="l00703"></a>00703                 }
<a name="l00704"></a>00704               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == ARG_INT)
<a name="l00705"></a>00705                 kb_item_add_int (kb, name, atoi (value));
<a name="l00706"></a>00706             }
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708       efree (&amp;value);
<a name="l00709"></a>00709       efree (&amp;name);
<a name="l00710"></a>00710       bzero (buf, <span class="keyword">sizeof</span> (buf));
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712   fclose (f);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714   <span class="comment">/*</span>
<a name="l00715"></a>00715 <span class="comment">   * Re-open the file</span>
<a name="l00716"></a>00716 <span class="comment">   */</span>
<a name="l00717"></a>00717   fd = open (fname, O_RDWR);
<a name="l00718"></a>00718   efree (&amp;fname);
<a name="l00719"></a>00719   <span class="keywordflow">if</span> (fd &gt; 0)
<a name="l00720"></a>00720     {
<a name="l00721"></a>00721       lseek (fd, 0, SEEK_END);
<a name="l00722"></a>00722       <span class="keywordflow">if</span> (arg_get_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>))
<a name="l00723"></a>00723         arg_set_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>, ARG_INT, GSIZE_TO_POINTER (fd));
<a name="l00724"></a>00724       <span class="keywordflow">else</span>
<a name="l00725"></a>00725         arg_add_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>, ARG_INT, <span class="keyword">sizeof</span> (gpointer),
<a name="l00726"></a>00726                        GSIZE_TO_POINTER (fd));
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728   <span class="keywordflow">else</span>
<a name="l00729"></a>00729     <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;ERROR - %s\n&quot;</span>, strerror (errno));
<a name="l00730"></a>00730   <span class="keywordflow">return</span> kb;
<a name="l00731"></a>00731 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a040936a210b4d0e3a67ffd14e4da912b"></a><!-- doxytag: member="save_kb.h::save_kb_new" ref="a040936a210b4d0e3a67ffd14e4da912b" args="(struct arglist *, char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb_new </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname"> <em>globals</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>hostname</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize a new KB that will be saved. </p>
<p>The indices of all the opened KB are in a hashlist in globals, saved under the name "save_kb". This makes no sense at this time, as the test of each <a class="el" href="structhost.html" title="Host information, implemented as doubly linked list.">host</a> is done in a separate process, but this allows us to regroup easily these in the future. </p>

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00403">403</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>References <a class="el" href="locks_8c_source.html#l00066">file_lock()</a>, <a class="el" href="locks_8c_source.html#l00101">file_locked()</a>, and <a class="el" href="log_8c_source.html#l00147">log_write()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00404"></a>00404 {
<a name="l00405"></a>00405   <span class="keywordtype">char</span> *fname;
<a name="l00406"></a>00406   <span class="keywordtype">char</span> *dir;
<a name="l00407"></a>00407   <span class="keywordtype">int</span> f;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409   <span class="keywordflow">if</span> (hostname == NULL)
<a name="l00410"></a>00410     <span class="keywordflow">return</span> -1;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412   dir = kb_dirname ();
<a name="l00413"></a>00413   kb_mkdir (dir);
<a name="l00414"></a>00414   efree (&amp;dir);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   fname = kb_fname (hostname);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (<a class="code" href="locks_8c.html#ac9109c8213cd8478105ec4b5b56e9b1c">file_locked</a> (fname))
<a name="l00419"></a>00419     {
<a name="l00420"></a>00420       efree (&amp;fname);
<a name="l00421"></a>00421       <span class="keywordflow">return</span> 0;
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423   unlink (fname);               <span class="comment">/* delete the previous kb */</span>
<a name="l00424"></a>00424   f = open (fname, O_CREAT | O_RDWR | O_EXCL, 0640);
<a name="l00425"></a>00425   <span class="keywordflow">if</span> (f &lt; 0)
<a name="l00426"></a>00426     {
<a name="l00427"></a>00427       <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;Can not save KB for %s - %s&quot;</span>, hostname,
<a name="l00428"></a>00428                  strerror (errno));
<a name="l00429"></a>00429       efree (&amp;fname);
<a name="l00430"></a>00430       <span class="keywordflow">return</span> -1;
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432   <span class="keywordflow">else</span>
<a name="l00433"></a>00433     {
<a name="l00434"></a>00434       <a class="code" href="locks_8c.html#a40b41c04a5df1cc6c64c26b508166a5d">file_lock</a> (fname);
<a name="l00435"></a>00435       <a class="code" href="log_8c.html#aebd780cf62bc3eed16f852bd30250a3a">log_write</a> (<span class="stringliteral">&quot;New KB will be saved as %s&quot;</span>, fname);
<a name="l00436"></a>00436       <span class="keywordflow">if</span> (arg_get_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>))
<a name="l00437"></a>00437         arg_set_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>, <span class="keyword">sizeof</span> (gpointer),
<a name="l00438"></a>00438                        GSIZE_TO_POINTER (f));
<a name="l00439"></a>00439       <span class="keywordflow">else</span>
<a name="l00440"></a>00440         arg_add_value (globals, <span class="stringliteral">&quot;save_kb&quot;</span>, ARG_INT, <span class="keyword">sizeof</span> (gpointer),
<a name="l00441"></a>00441                        GSIZE_TO_POINTER (f));
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443   <span class="keywordflow">return</span> 0;
<a name="l00444"></a>00444 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="abd4579c550b96a4ad31892115d321f03"></a><!-- doxytag: member="save_kb.h::save_kb_restore_backup" ref="abd4579c550b96a4ad31892115d321f03" args="(char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb_restore_backup </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Restores a copy of the knowledge base. </p>

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00517">517</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00518"></a>00518 {
<a name="l00519"></a>00519   <span class="keywordtype">char</span> *fname = kb_fname (hostname);
<a name="l00520"></a>00520   <span class="keywordtype">char</span> *bakname;
<a name="l00521"></a>00521   <span class="keywordtype">int</span> fd;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   bakname = emalloc (strlen (fname) + 5);
<a name="l00524"></a>00524   strcat (bakname, fname);
<a name="l00525"></a>00525   strcat (bakname, <span class="stringliteral">&quot;.bak&quot;</span>);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527   unlink (fname);
<a name="l00528"></a>00528   <span class="keywordflow">if</span> ((fd = open (bakname, O_RDONLY)) &gt;= 0)
<a name="l00529"></a>00529     {
<a name="l00530"></a>00530       close (fd);
<a name="l00531"></a>00531       rename (bakname, fname);
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533   <span class="keywordflow">return</span> 0;
<a name="l00534"></a>00534 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae6ef6f02804f7e7826ae2ba723450c78"></a><!-- doxytag: member="save_kb.h::save_kb_write_int" ref="ae6ef6f02804f7e7826ae2ba723450c78" args="(struct arglist *, char *, char *, int)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb_write_int </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00500">500</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>Referenced by <a class="el" href="piic_8c_source.html#l00055">kb_parse()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00502"></a>00502 {
<a name="l00503"></a>00503   <span class="keyword">static</span> <span class="keywordtype">char</span> asc_value[25];
<a name="l00504"></a>00504   <span class="keywordtype">int</span> e;
<a name="l00505"></a>00505   sprintf (asc_value, <span class="stringliteral">&quot;%d&quot;</span>, value);
<a name="l00506"></a>00506   e = save_kb_write (globals, hostname, name, asc_value, ARG_INT);
<a name="l00507"></a>00507   bzero (asc_value, <span class="keyword">sizeof</span> (asc_value));
<a name="l00508"></a>00508   <span class="keywordflow">return</span> e;
<a name="l00509"></a>00509 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a4e5f053311a1d7e7a52c8207862bc195"></a><!-- doxytag: member="save_kb.h::save_kb_write_str" ref="a4e5f053311a1d7e7a52c8207862bc195" args="(struct arglist *, char *, char *, char *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int save_kb_write_str </td>
          <td>(</td>
          <td class="paramtype">struct arglist *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="save__kb_8c_source.html#l00487">487</a> of file <a class="el" href="save__kb_8c_source.html">save_kb.c</a>.</p>

<p>Referenced by <a class="el" href="piic_8c_source.html#l00055">kb_parse()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00489"></a>00489 {
<a name="l00490"></a>00490   <span class="keywordtype">char</span> *newvalue = addslashes (value);
<a name="l00491"></a>00491   <span class="keywordtype">int</span> e;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   e = save_kb_write (globals, hostname, name, newvalue, ARG_STRING);
<a name="l00494"></a>00494   efree (&amp;newvalue);
<a name="l00495"></a>00495   <span class="keywordflow">return</span> e;
<a name="l00496"></a>00496 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 23 Oct 2015 for OpenVAS Scanner by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
