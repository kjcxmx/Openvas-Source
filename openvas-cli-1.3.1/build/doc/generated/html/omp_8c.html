<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OpenVAS CLI: omp/omp.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_88373d39c5257a2c1bc1f8c5fcdd06a9.html">omp</a>
  </div>
</div>
<div class="contents">
<h1>omp.c File Reference</h1>
<p>The OMP Command Line Interface.  
<a href="#_details">More...</a></p>
<code>#include &lt;assert.h&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &lt;glib.h&gt;</code><br/>
<code>#include &lt;locale.h&gt;</code><br/>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;termios.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;openvas/misc/openvas_server.h&gt;</code><br/>
<code>#include &lt;openvas/misc/openvas_logging.h&gt;</code><br/>
<code>#include &lt;openvas/omp/omp.h&gt;</code><br/>
<code>#include &lt;openvas/omp/xml.h&gt;</code><br/>
<div class="dynheader">
Include dependency graph for omp.c:</div>
<div class="dynsection">
</div>

<p><a href="omp_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structserver__connection__t.html">server_connection_t</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Information needed to handle a connection to a server.  <a href="structserver__connection__t.html#_details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#a369266c24eacffb87046522897a570d5">_GNU_SOURCE</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#a461b1800181390fcfc1ab7df4f84e4fe">OMP_PROGNAME</a>&nbsp;&nbsp;&nbsp;&quot;omp&quot;</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The name of this program.  <a href="#a461b1800181390fcfc1ab7df4f84e4fe"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#afa8b87beee6b1d2c4b16ca80b336de88">OPENVASMD_ADDRESS</a>&nbsp;&nbsp;&nbsp;&quot;127.0.0.1&quot;</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Default Manager (openvasmd) address.  <a href="#afa8b87beee6b1d2c4b16ca80b336de88"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#ad97d19a93a8a4daec3b2fb200572e037">OPENVASMD_PORT</a>&nbsp;&nbsp;&nbsp;9390</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Default Manager port.  <a href="#ad97d19a93a8a4daec3b2fb200572e037"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#a3b22f0c8ff4318d41e5e7cca5a827e6d">SENDFILE_STR</a>&nbsp;&nbsp;&nbsp;&quot;SENDFILE&quot;</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Substring to replace when using --send-file option.  <a href="#a3b22f0c8ff4318d41e5e7cca5a827e6d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#ace11d8e3ed80e27635377d069a602788">DEFAULT_PING_TIMEOUT</a>&nbsp;&nbsp;&nbsp;10</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Default timeout value for OMP pings.  <a href="#ace11d8e3ed80e27635377d069a602788"></a><br/></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#a6494b5459d38159e9d40bc4fa05b69e3">get_configs</a> (gnutls_session_t *session, entity_t *status)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the list of scan configs.  <a href="#a6494b5459d38159e9d40bc4fa05b69e3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">ssize_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#a942946652df6b97b0b80eda4b5d77b89">read_password</a> (char **lineptr, size_t *n, FILE *stream)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reads an entire line from a stream, suppressing character output.  <a href="#a942946652df6b97b0b80eda4b5d77b89"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="omp_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>The OMP Command Line Interface. </p>
<p>This command line tool provides command line arguments corresponding to the OMP protocol commands as well as a direct method to send OMP protocol commands (which is based on XML). </p>

<p>Definition in file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a369266c24eacffb87046522897a570d5"></a><!-- doxytag: member="omp.c::_GNU_SOURCE" ref="a369266c24eacffb87046522897a570d5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _GNU_SOURCE</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="omp_8c_source.html#l00049">49</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

</div>
</div>
<a class="anchor" id="ace11d8e3ed80e27635377d069a602788"></a><!-- doxytag: member="omp.c::DEFAULT_PING_TIMEOUT" ref="ace11d8e3ed80e27635377d069a602788" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_PING_TIMEOUT&nbsp;&nbsp;&nbsp;10</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Default timeout value for OMP pings. </p>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00097">97</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

<p>Referenced by <a class="el" href="omp_8c_source.html#l00958">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a461b1800181390fcfc1ab7df4f84e4fe"></a><!-- doxytag: member="omp.c::OMP_PROGNAME" ref="a461b1800181390fcfc1ab7df4f84e4fe" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OMP_PROGNAME&nbsp;&nbsp;&nbsp;&quot;omp&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The name of this program. </p>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00076">76</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

</div>
</div>
<a class="anchor" id="afa8b87beee6b1d2c4b16ca80b336de88"></a><!-- doxytag: member="omp.c::OPENVASMD_ADDRESS" ref="afa8b87beee6b1d2c4b16ca80b336de88" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OPENVASMD_ADDRESS&nbsp;&nbsp;&nbsp;&quot;127.0.0.1&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Default Manager (openvasmd) address. </p>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00081">81</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

<p>Referenced by <a class="el" href="check__omp_8c_source.html#l00909">main()</a>.</p>

</div>
</div>
<a class="anchor" id="ad97d19a93a8a4daec3b2fb200572e037"></a><!-- doxytag: member="omp.c::OPENVASMD_PORT" ref="ad97d19a93a8a4daec3b2fb200572e037" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OPENVASMD_PORT&nbsp;&nbsp;&nbsp;9390</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Default Manager port. </p>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00086">86</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

<p>Referenced by <a class="el" href="check__omp_8c_source.html#l00909">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a3b22f0c8ff4318d41e5e7cca5a827e6d"></a><!-- doxytag: member="omp.c::SENDFILE_STR" ref="a3b22f0c8ff4318d41e5e7cca5a827e6d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SENDFILE_STR&nbsp;&nbsp;&nbsp;&quot;SENDFILE&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Substring to replace when using --send-file option. </p>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00092">92</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a6494b5459d38159e9d40bc4fa05b69e3"></a><!-- doxytag: member="omp.c::get_configs" ref="a6494b5459d38159e9d40bc4fa05b69e3" args="(gnutls_session_t *session, entity_t *status)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_configs </td>
          <td>(</td>
          <td class="paramtype">gnutls_session_t *&nbsp;</td>
          <td class="paramname"> <em>session</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">entity_t *&nbsp;</td>
          <td class="paramname"> <em>status</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the list of scan configs. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>session</em>&nbsp;</td><td>Pointer to GNUTLS session. </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>status</em>&nbsp;</td><td>Status return. On success contains GET_CONFIGS response.</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 on success, -1 or OMP response code on error. </dd></dl>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00473">473</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

<p>Referenced by <a class="el" href="omp_8c_source.html#l00958">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00474"></a>00474 {
<a name="l00475"></a>00475   <span class="keyword">const</span> <span class="keywordtype">char</span>* status_code;
<a name="l00476"></a>00476   <span class="keywordtype">int</span> ret;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   <span class="keywordflow">if</span> (openvas_server_sendf (session, <span class="stringliteral">&quot;&lt;get_configs/&gt;&quot;</span>) == -1)
<a name="l00479"></a>00479     <span class="keywordflow">return</span> -1;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="comment">/* Read the response. */</span>
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   *status = NULL;
<a name="l00484"></a>00484   <span class="keywordflow">if</span> (read_entity (session, status)) <span class="keywordflow">return</span> -1;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486   <span class="comment">/* Check the response. */</span>
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   status_code = entity_attribute (*status, <span class="stringliteral">&quot;status&quot;</span>);
<a name="l00489"></a>00489   <span class="keywordflow">if</span> (status_code == NULL)
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491       free_entity (*status);
<a name="l00492"></a>00492       <span class="keywordflow">return</span> -1;
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494   <span class="keywordflow">if</span> (strlen (status_code) == 0)
<a name="l00495"></a>00495     {
<a name="l00496"></a>00496       free_entity (*status);
<a name="l00497"></a>00497       <span class="keywordflow">return</span> -1;
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499   <span class="keywordflow">if</span> (status_code[0] == <span class="charliteral">&apos;2&apos;</span>) <span class="keywordflow">return</span> 0;
<a name="l00500"></a>00500   ret = (int) strtol (status_code, NULL, 10);
<a name="l00501"></a>00501   free_entity (*status);
<a name="l00502"></a>00502   <span class="keywordflow">if</span> (errno == ERANGE) <span class="keywordflow">return</span> -1;
<a name="l00503"></a>00503   <span class="keywordflow">return</span> ret;
<a name="l00504"></a>00504 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a3c04138a5bfe5d72780bb7e82a18e627"></a><!-- doxytag: member="omp.c::main" ref="a3c04138a5bfe5d72780bb7e82a18e627" args="(int argc, char **argv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>argv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>Other modules ship with log level set to warning. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Move to connection_t and manager_open. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd>Move to connection_t and manager_open. </dd></dl>
</p>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00958">958</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

<p>References <a class="el" href="omp_8c_source.html#l00097">DEFAULT_PING_TIMEOUT</a>, <a class="el" href="omp_8c_source.html#l00473">get_configs()</a>, <a class="el" href="omp_8c_source.html#l00110">server_connection_t::host_string</a>, <a class="el" href="omp_8c_source.html#l00081">OPENVASMD_ADDRESS</a>, <a class="el" href="omp_8c_source.html#l00086">OPENVASMD_PORT</a>, <a class="el" href="omp_8c_source.html#l00109">server_connection_t::password</a>, <a class="el" href="omp_8c_source.html#l00112">server_connection_t::port</a>, <a class="el" href="omp_8c_source.html#l00111">server_connection_t::port_string</a>, <a class="el" href="omp_8c_source.html#l00818">read_password()</a>, <a class="el" href="omp_8c_source.html#l00106">server_connection_t::session</a>, <a class="el" href="omp_8c_source.html#l00114">server_connection_t::timeout</a>, <a class="el" href="omp_8c_source.html#l00113">server_connection_t::use_certs</a>, and <a class="el" href="omp_8c_source.html#l00108">server_connection_t::username</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00959"></a>00959 {
<a name="l00960"></a>00960   <a class="code" href="structserver__connection__t.html" title="Information needed to handle a connection to a server.">server_connection_t</a> *connection = NULL;
<a name="l00961"></a>00961   <span class="comment">/* The return status of the command. */</span>
<a name="l00962"></a>00962   <span class="keywordtype">int</span> exit_status = -1;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964   <span class="comment">/* Global options. */</span>
<a name="l00965"></a>00965   <span class="keyword">static</span> gboolean prompt = FALSE;
<a name="l00966"></a>00966   <span class="keyword">static</span> gboolean print_version = FALSE;
<a name="l00967"></a>00967   <span class="keyword">static</span> gboolean be_verbose = FALSE;
<a name="l00968"></a>00968   <span class="keyword">static</span> gboolean use_certs = FALSE;
<a name="l00969"></a>00969   <span class="keyword">static</span> gchar *conf_file_path = NULL;
<a name="l00970"></a>00970   <span class="keyword">static</span> gchar *send_file_path = NULL;
<a name="l00971"></a>00971   <span class="keyword">static</span> gchar *manager_host_string = NULL;
<a name="l00972"></a>00972   <span class="keyword">static</span> gchar *manager_port_string = NULL;
<a name="l00973"></a>00973   <span class="keyword">static</span> gchar *omp_username = NULL;
<a name="l00974"></a>00974   <span class="keyword">static</span> gchar *omp_password = NULL;
<a name="l00975"></a>00975   <span class="comment">/* Shared command options. */</span>
<a name="l00976"></a>00976   <span class="keyword">static</span> gchar *name = NULL;
<a name="l00977"></a>00977   <span class="comment">/* Command create-task. */</span>
<a name="l00978"></a>00978   <span class="keyword">static</span> gboolean cmd_create_task = FALSE;
<a name="l00979"></a>00979   <span class="keyword">static</span> gchar *comment = NULL;
<a name="l00980"></a>00980   <span class="keyword">static</span> gchar *config = NULL;
<a name="l00981"></a>00981   <span class="keyword">static</span> gchar *target = NULL;
<a name="l00982"></a>00982   <span class="comment">/* Command delete-report. */</span>
<a name="l00983"></a>00983   <span class="keyword">static</span> gboolean cmd_delete_report = FALSE;
<a name="l00984"></a>00984   <span class="comment">/* Command delete-task. */</span>
<a name="l00985"></a>00985   <span class="keyword">static</span> gboolean cmd_delete_task = FALSE;
<a name="l00986"></a>00986   <span class="comment">/* Command get-report. */</span>
<a name="l00987"></a>00987   <span class="keyword">static</span> gboolean cmd_get_report = FALSE;
<a name="l00988"></a>00988   <span class="comment">/* Command get-report-formats. */</span>
<a name="l00989"></a>00989   <span class="keyword">static</span> gboolean cmd_get_report_formats = FALSE;
<a name="l00990"></a>00990   <span class="comment">/* Command get-omp-version. */</span>
<a name="l00991"></a>00991   <span class="keyword">static</span> gboolean cmd_get_omp_version = FALSE;
<a name="l00992"></a>00992   <span class="keyword">static</span> gchar *format = NULL;
<a name="l00993"></a>00993   <span class="comment">/* Command get-tasks. */</span>
<a name="l00994"></a>00994   <span class="keyword">static</span> gboolean cmd_get_tasks = FALSE;
<a name="l00995"></a>00995   <span class="comment">/* Command get-configs. */</span>
<a name="l00996"></a>00996   <span class="keyword">static</span> gboolean cmd_get_configs = FALSE;
<a name="l00997"></a>00997   <span class="comment">/* Command get-targets. */</span>
<a name="l00998"></a>00998   <span class="keyword">static</span> gboolean cmd_get_targets = FALSE;
<a name="l00999"></a>00999   <span class="comment">/* Command modify-task. */</span>
<a name="l01000"></a>01000   <span class="keyword">static</span> gboolean cmd_modify_task = FALSE;
<a name="l01001"></a>01001   <span class="keyword">static</span> gboolean file = FALSE;
<a name="l01002"></a>01002   <span class="comment">/* Command start-task. */</span>
<a name="l01003"></a>01003   <span class="keyword">static</span> gboolean cmd_start_task = FALSE;
<a name="l01004"></a>01004   <span class="comment">/* Command ping. */</span>
<a name="l01005"></a>01005   <span class="keyword">static</span> gboolean cmd_ping = FALSE;
<a name="l01006"></a>01006   <span class="keyword">static</span> gint ping_timeout = <a class="code" href="omp_8c.html#ace11d8e3ed80e27635377d069a602788" title="Default timeout value for OMP pings.">DEFAULT_PING_TIMEOUT</a>;
<a name="l01007"></a>01007   <span class="comment">/* Command given as XML. */</span>
<a name="l01008"></a>01008   <span class="keyword">static</span> gchar *cmd_xml = NULL;
<a name="l01009"></a>01009   <span class="comment">/* The rest of the args. */</span>
<a name="l01010"></a>01010   <span class="keyword">static</span> gchar **rest = NULL;
<a name="l01011"></a>01011   <span class="comment">/* Pretty print option. */</span>
<a name="l01012"></a>01012   <span class="keyword">static</span> gboolean pretty_print = FALSE;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014   GError *error = NULL;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016   GOptionContext *option_context;
<a name="l01017"></a>01017   <span class="keyword">static</span> GOptionEntry option_entries[] = {
<a name="l01018"></a>01018     <span class="comment">/* Global options. */</span>
<a name="l01019"></a>01019     {<span class="stringliteral">&quot;host&quot;</span>, <span class="charliteral">&apos;h&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;manager_host_string,
<a name="l01020"></a>01020      <span class="stringliteral">&quot;Connect to manager on host &lt;host&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;host&gt;&quot;</span>},
<a name="l01021"></a>01021     {<span class="stringliteral">&quot;port&quot;</span>, <span class="charliteral">&apos;p&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;manager_port_string,
<a name="l01022"></a>01022      <span class="stringliteral">&quot;Use port number &lt;number&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;number&gt;&quot;</span>},
<a name="l01023"></a>01023     {<span class="stringliteral">&quot;version&quot;</span>, <span class="charliteral">&apos;V&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;print_version,
<a name="l01024"></a>01024      <span class="stringliteral">&quot;Print version.&quot;</span>, NULL},
<a name="l01025"></a>01025     {<span class="stringliteral">&quot;verbose&quot;</span>, <span class="charliteral">&apos;v&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;be_verbose,
<a name="l01026"></a>01026      <span class="stringliteral">&quot;Verbose messages (WARNING: may reveal passwords).&quot;</span>, NULL},
<a name="l01027"></a>01027     {<span class="stringliteral">&quot;use-certs&quot;</span>, 0, 0, G_OPTION_ARG_NONE, &amp;use_certs,
<a name="l01028"></a>01028      <span class="stringliteral">&quot;Use client certificates to authenticate&quot;</span>, NULL},
<a name="l01029"></a>01029     {<span class="stringliteral">&quot;username&quot;</span>, <span class="charliteral">&apos;u&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;omp_username,
<a name="l01030"></a>01030      <span class="stringliteral">&quot;OMP username&quot;</span>, <span class="stringliteral">&quot;&lt;username&gt;&quot;</span>},
<a name="l01031"></a>01031     {<span class="stringliteral">&quot;password&quot;</span>, <span class="charliteral">&apos;w&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;omp_password,
<a name="l01032"></a>01032      <span class="stringliteral">&quot;OMP password&quot;</span>, <span class="stringliteral">&quot;&lt;password&gt;&quot;</span>},
<a name="l01033"></a>01033     {<span class="stringliteral">&quot;config-file&quot;</span>, 0, 0, G_OPTION_ARG_FILENAME, &amp;conf_file_path,
<a name="l01034"></a>01034      <span class="stringliteral">&quot;Configuration file for connection parameters.&quot;</span>, <span class="stringliteral">&quot;&lt;config-file&gt;&quot;</span>},
<a name="l01035"></a>01035     {<span class="stringliteral">&quot;prompt&quot;</span>, <span class="charliteral">&apos;P&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;prompt,
<a name="l01036"></a>01036      <span class="stringliteral">&quot;Prompt to exit.&quot;</span>, NULL},
<a name="l01037"></a>01037     {<span class="stringliteral">&quot;get-omp-version&quot;</span>, <span class="charliteral">&apos;O&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_get_omp_version,
<a name="l01038"></a>01038      <span class="stringliteral">&quot;Print OMP version.&quot;</span>, NULL},
<a name="l01039"></a>01039     <span class="comment">/* Shared command options. */</span>
<a name="l01040"></a>01040     {<span class="stringliteral">&quot;name&quot;</span>, <span class="charliteral">&apos;n&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;name,
<a name="l01041"></a>01041      <span class="stringliteral">&quot;Name for create-task.&quot;</span>,
<a name="l01042"></a>01042      <span class="stringliteral">&quot;&lt;name&gt;&quot;</span>},
<a name="l01043"></a>01043     <span class="comment">/* Command create-task. */</span>
<a name="l01044"></a>01044     {<span class="stringliteral">&quot;create-task&quot;</span>, <span class="charliteral">&apos;C&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_create_task,
<a name="l01045"></a>01045      <span class="stringliteral">&quot;Create a task.&quot;</span>, NULL},
<a name="l01046"></a>01046     {<span class="stringliteral">&quot;comment&quot;</span>, <span class="charliteral">&apos;m&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;comment,
<a name="l01047"></a>01047      <span class="stringliteral">&quot;Comment for create-task.&quot;</span>,
<a name="l01048"></a>01048      <span class="stringliteral">&quot;&lt;name&gt;&quot;</span>},
<a name="l01049"></a>01049     {<span class="stringliteral">&quot;config&quot;</span>, <span class="charliteral">&apos;c&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;config,
<a name="l01050"></a>01050      <span class="stringliteral">&quot;Config for create-task.&quot;</span>,
<a name="l01051"></a>01051      <span class="stringliteral">&quot;&lt;config&gt;&quot;</span>},
<a name="l01052"></a>01052     {<span class="stringliteral">&quot;target&quot;</span>, <span class="charliteral">&apos;t&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;target,
<a name="l01053"></a>01053      <span class="stringliteral">&quot;Target for create-task.&quot;</span>,
<a name="l01054"></a>01054      <span class="stringliteral">&quot;&lt;target&gt;&quot;</span>},
<a name="l01055"></a>01055     <span class="comment">/* Command delete-report. */</span>
<a name="l01056"></a>01056     {<span class="stringliteral">&quot;delete-report&quot;</span>, <span class="charliteral">&apos;E&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_delete_report,
<a name="l01057"></a>01057      <span class="stringliteral">&quot;Delete one or more reports.&quot;</span>, NULL},
<a name="l01058"></a>01058     <span class="comment">/* Command delete-task. */</span>
<a name="l01059"></a>01059     {<span class="stringliteral">&quot;delete-task&quot;</span>, <span class="charliteral">&apos;D&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_delete_task,
<a name="l01060"></a>01060      <span class="stringliteral">&quot;Delete one or more tasks.&quot;</span>, NULL},
<a name="l01061"></a>01061     <span class="comment">/* Command get-report. */</span>
<a name="l01062"></a>01062     {<span class="stringliteral">&quot;get-report&quot;</span>, <span class="charliteral">&apos;R&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_get_report,
<a name="l01063"></a>01063      <span class="stringliteral">&quot;Get report of one task.&quot;</span>, NULL},
<a name="l01064"></a>01064     {<span class="stringliteral">&quot;get-report-formats&quot;</span>, <span class="charliteral">&apos;F&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_get_report_formats,
<a name="l01065"></a>01065      <span class="stringliteral">&quot;Get report formats. (OMP 2.0 only)&quot;</span>, NULL},
<a name="l01066"></a>01066     {<span class="stringliteral">&quot;format&quot;</span>, <span class="charliteral">&apos;f&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;format,
<a name="l01067"></a>01067      <span class="stringliteral">&quot;Format for get-report.&quot;</span>,
<a name="l01068"></a>01068      <span class="stringliteral">&quot;&lt;format&gt;&quot;</span>},
<a name="l01069"></a>01069     <span class="comment">/* Command get-tasks. */</span>
<a name="l01070"></a>01070     {<span class="stringliteral">&quot;get-tasks&quot;</span>, <span class="charliteral">&apos;G&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_get_tasks,
<a name="l01071"></a>01071      <span class="stringliteral">&quot;Get status of one, many or all tasks.&quot;</span>, NULL},
<a name="l01072"></a>01072     <span class="comment">/* Command get-configs. */</span>
<a name="l01073"></a>01073     {<span class="stringliteral">&quot;get-configs&quot;</span>, <span class="charliteral">&apos;g&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_get_configs,
<a name="l01074"></a>01074      <span class="stringliteral">&quot;Get configs.&quot;</span>, NULL},
<a name="l01075"></a>01075     <span class="comment">/* Command get-targets. */</span>
<a name="l01076"></a>01076     {<span class="stringliteral">&quot;get-targets&quot;</span>, <span class="charliteral">&apos;T&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_get_targets,
<a name="l01077"></a>01077      <span class="stringliteral">&quot;Get targets.&quot;</span>, NULL},
<a name="l01078"></a>01078     <span class="comment">/* Pretty printing for &quot;direct&quot; xml (in combination with -X). */</span>
<a name="l01079"></a>01079     {<span class="stringliteral">&quot;pretty-print&quot;</span>, <span class="charliteral">&apos;i&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;pretty_print,
<a name="l01080"></a>01080      <span class="stringliteral">&quot;In combination with -X, pretty print the response.&quot;</span>, NULL},
<a name="l01081"></a>01081     <span class="comment">/* Command start-task. */</span>
<a name="l01082"></a>01082     {<span class="stringliteral">&quot;start-task&quot;</span>, <span class="charliteral">&apos;S&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_start_task,
<a name="l01083"></a>01083      <span class="stringliteral">&quot;Start one or more tasks.&quot;</span>, NULL},
<a name="l01084"></a>01084     <span class="comment">/* Command modify-task. */</span>
<a name="l01085"></a>01085     {<span class="stringliteral">&quot;modify-task&quot;</span>, <span class="charliteral">&apos;M&apos;</span>, 0, G_OPTION_ARG_NONE, &amp;cmd_modify_task,
<a name="l01086"></a>01086      <span class="stringliteral">&quot;Modify a task.&quot;</span>, NULL},
<a name="l01087"></a>01087     <span class="comment">/* Command ping. */</span>
<a name="l01088"></a>01088     {<span class="stringliteral">&quot;ping&quot;</span>, 0, 0, G_OPTION_ARG_NONE, &amp;cmd_ping,
<a name="l01089"></a>01089      <span class="stringliteral">&quot;Ping OMP server&quot;</span>, NULL},
<a name="l01090"></a>01090     {<span class="stringliteral">&quot;timeout&quot;</span>, <span class="charliteral">&apos;t&apos;</span>, 0, G_OPTION_ARG_INT, &amp;ping_timeout,
<a name="l01091"></a>01091      <span class="stringliteral">&quot;Wait &lt;number&gt; seconds for OMP ping response&quot;</span>, <span class="stringliteral">&quot;&lt;number&gt;&quot;</span>},
<a name="l01092"></a>01092     {<span class="stringliteral">&quot;file&quot;</span>, 0, 0, G_OPTION_ARG_NONE, &amp;file,
<a name="l01093"></a>01093      <span class="stringliteral">&quot;Add text in stdin as file on task.&quot;</span>, NULL},
<a name="l01094"></a>01094     <span class="comment">/* Command as XML. */</span>
<a name="l01095"></a>01095     {<span class="stringliteral">&quot;xml&quot;</span>, <span class="charliteral">&apos;X&apos;</span>, 0, G_OPTION_ARG_STRING, &amp;cmd_xml,
<a name="l01096"></a>01096      <span class="stringliteral">&quot;XML command (e.g. \&quot;&lt;help/&gt;\&quot;\&quot;).  \&quot;-\&quot; to read from stdin.&quot;</span>,
<a name="l01097"></a>01097      <span class="stringliteral">&quot;&lt;command&gt;&quot;</span>},
<a name="l01098"></a>01098     {<span class="stringliteral">&quot;send-file&quot;</span>, 0, 0, G_OPTION_ARG_FILENAME, &amp;send_file_path,
<a name="l01099"></a>01099      <span class="stringliteral">&quot;Replace SENDFILE in xml with base64 of file.&quot;</span>, <span class="stringliteral">&quot;&lt;file&gt;&quot;</span>},
<a name="l01100"></a>01100     {G_OPTION_REMAINING, 0, 0, G_OPTION_ARG_STRING_ARRAY, &amp;rest,
<a name="l01101"></a>01101      NULL, NULL},
<a name="l01102"></a>01102     {NULL}
<a name="l01103"></a>01103   };
<a name="l01104"></a>01104 
<a name="l01105"></a>01105   <span class="keywordflow">if</span> (setlocale (LC_ALL, <span class="stringliteral">&quot;&quot;</span>) == NULL)
<a name="l01106"></a>01106     {
<a name="l01107"></a>01107       printf (<span class="stringliteral">&quot;Failed to setlocale\n\n&quot;</span>);
<a name="l01108"></a>01108       exit (EXIT_FAILURE);
<a name="l01109"></a>01109     }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111   option_context =
<a name="l01112"></a>01112     g_option_context_new (<span class="stringliteral">&quot;- OpenVAS OMP Command Line Interface&quot;</span>);
<a name="l01113"></a>01113   g_option_context_add_main_entries (option_context, option_entries, NULL);
<a name="l01114"></a>01114   <span class="keywordflow">if</span> (!g_option_context_parse (option_context, &amp;argc, &amp;argv, &amp;error))
<a name="l01115"></a>01115     {
<a name="l01116"></a>01116       printf (<span class="stringliteral">&quot;%s\n\n&quot;</span>, error-&gt;message);
<a name="l01117"></a>01117       exit (EXIT_FAILURE);
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120   <span class="comment">/* Check for Windows style help request */</span>
<a name="l01121"></a>01121   <span class="keywordflow">if</span> (rest != NULL &amp;&amp; *rest != NULL)
<a name="l01122"></a>01122     {
<a name="l01123"></a>01123       <span class="keywordflow">if</span> (g_strstr_len (*rest, -1, <span class="stringliteral">&quot;/?&quot;</span>) != NULL)
<a name="l01124"></a>01124         {
<a name="l01125"></a>01125           printf (<span class="stringliteral">&quot;%s&quot;</span>, g_option_context_get_help (option_context, TRUE, NULL));
<a name="l01126"></a>01126           exit (EXIT_SUCCESS);
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130   <span class="keywordflow">if</span> (print_version)
<a name="l01131"></a>01131     {
<a name="l01132"></a>01132       printf (<span class="stringliteral">&quot;OMP Command Line Interface %s\n&quot;</span>, OPENVASCLI_VERSION);
<a name="l01133"></a>01133       printf (<span class="stringliteral">&quot;Copyright (C) 2010-2013 Greenbone Networks GmbH\n&quot;</span>);
<a name="l01134"></a>01134       printf (<span class="stringliteral">&quot;License GPLv2+: GNU GPL version 2 or later\n&quot;</span>);
<a name="l01135"></a>01135       printf
<a name="l01136"></a>01136         (<span class="stringliteral">&quot;This is free software: you are free to change and redistribute it.\n&quot;</span>
<a name="l01137"></a>01137          <span class="stringliteral">&quot;There is NO WARRANTY, to the extent permitted by law.\n\n&quot;</span>);
<a name="l01138"></a>01138       exit (EXIT_SUCCESS);
<a name="l01139"></a>01139     }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141   <span class="comment">/* Check that one and at most one command option is present. */</span>
<a name="l01142"></a>01142   {
<a name="l01143"></a>01143     <span class="keywordtype">int</span> commands;
<a name="l01144"></a>01144     commands =
<a name="l01145"></a>01145       (int) cmd_create_task + (<span class="keywordtype">int</span>) cmd_delete_report + (int) cmd_delete_task +
<a name="l01146"></a>01146       (<span class="keywordtype">int</span>) cmd_get_report + (<span class="keywordtype">int</span>) cmd_get_report_formats +
<a name="l01147"></a>01147       (<span class="keywordtype">int</span>) cmd_get_tasks + (<span class="keywordtype">int</span>) cmd_modify_task + (<span class="keywordtype">int</span>) cmd_start_task +
<a name="l01148"></a>01148       (<span class="keywordtype">int</span>) cmd_get_targets + (<span class="keywordtype">int</span>) cmd_get_omp_version + (<span class="keywordtype">int</span>) cmd_get_configs +
<a name="l01149"></a>01149       (<span class="keywordtype">int</span>) cmd_ping + (<span class="keywordtype">int</span>) (cmd_xml != NULL);
<a name="l01150"></a>01150     if (commands == 0)
<a name="l01151"></a>01151       {
<a name="l01152"></a>01152         fprintf (stderr, <span class="stringliteral">&quot;One command option must be present.\n&quot;</span>);
<a name="l01153"></a>01153         exit (EXIT_FAILURE);
<a name="l01154"></a>01154       }
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (commands &gt; 1)
<a name="l01156"></a>01156       {
<a name="l01157"></a>01157         fprintf (stderr, <span class="stringliteral">&quot;Only one command option must be present.\n&quot;</span>);
<a name="l01158"></a>01158         exit (EXIT_FAILURE);
<a name="l01159"></a>01159       }
<a name="l01160"></a>01160   }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162   <span class="comment">/* Setup the connection structure from the arguments and conf file.</span>
<a name="l01163"></a>01163 <span class="comment">   * Precedence of values is the following:</span>
<a name="l01164"></a>01164 <span class="comment">   * 1) command line argument (e.g. --port) 2) conf file 3) default */</span>
<a name="l01165"></a>01165 
<a name="l01166"></a>01166   <span class="keywordflow">if</span> (conf_file_path == NULL)
<a name="l01167"></a>01167     conf_file_path = g_build_filename (g_get_home_dir (), <span class="stringliteral">&quot;omp.config&quot;</span>, NULL);
<a name="l01168"></a>01168   connection = connection_from_file (conf_file_path);
<a name="l01169"></a>01169   g_free (conf_file_path);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171   <span class="keywordflow">if</span> (manager_host_string != NULL)
<a name="l01172"></a>01172     connection-&gt;<a class="code" href="structserver__connection__t.html#ad5f6fa44ac42acaa8333b5dfd00b094c" title="Server host string.">host_string</a> = manager_host_string;
<a name="l01173"></a>01173   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structserver__connection__t.html#ad5f6fa44ac42acaa8333b5dfd00b094c" title="Server host string.">host_string</a> == NULL)
<a name="l01174"></a>01174     connection-&gt;<a class="code" href="structserver__connection__t.html#ad5f6fa44ac42acaa8333b5dfd00b094c" title="Server host string.">host_string</a> = <a class="code" href="omp_8c.html#afa8b87beee6b1d2c4b16ca80b336de88" title="Default Manager (openvasmd) address.">OPENVASMD_ADDRESS</a>;
<a name="l01175"></a>01175 
<a name="l01176"></a>01176   <span class="keywordflow">if</span> (manager_port_string != NULL)
<a name="l01177"></a>01177     connection-&gt;<a class="code" href="structserver__connection__t.html#aa2137ea29992e3851af1cf5e3c7f3887" title="Port of server.">port</a> = atoi (manager_port_string);
<a name="l01178"></a>01178   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structserver__connection__t.html#af854d4165ee291b239027a24b539e231" title="Server port string.">port_string</a> != NULL)
<a name="l01179"></a>01179     connection-&gt;<a class="code" href="structserver__connection__t.html#aa2137ea29992e3851af1cf5e3c7f3887" title="Port of server.">port</a> = atoi (connection-&gt;<a class="code" href="structserver__connection__t.html#af854d4165ee291b239027a24b539e231" title="Server port string.">port_string</a>);
<a name="l01180"></a>01180   <span class="keywordflow">else</span>
<a name="l01181"></a>01181     connection-&gt;<a class="code" href="structserver__connection__t.html#aa2137ea29992e3851af1cf5e3c7f3887" title="Port of server.">port</a> = <a class="code" href="omp_8c.html#ad97d19a93a8a4daec3b2fb200572e037" title="Default Manager port.">OPENVASMD_PORT</a>;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183   <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structserver__connection__t.html#aa2137ea29992e3851af1cf5e3c7f3887" title="Port of server.">port</a> &lt;= 0 || connection-&gt;<a class="code" href="structserver__connection__t.html#aa2137ea29992e3851af1cf5e3c7f3887" title="Port of server.">port</a> &gt;= 65536)
<a name="l01184"></a>01184     {
<a name="l01185"></a>01185       fprintf (stderr, <span class="stringliteral">&quot;Manager port must be a number between 0 and 65536.\n&quot;</span>);
<a name="l01186"></a>01186       exit (EXIT_FAILURE);
<a name="l01187"></a>01187     }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189   connection-&gt;<a class="code" href="structserver__connection__t.html#ad5a237f7f3aee0e0005e628c3587dfe6" title="Use client certificates to authenticate.">use_certs</a> = use_certs;
<a name="l01190"></a>01190   <span class="keywordflow">if</span> (omp_username != NULL)
<a name="l01191"></a>01191     connection-&gt;<a class="code" href="structserver__connection__t.html#a61a7e80906ce19c0dc25a92059bd62a1" title="Username with which to connect.">username</a> = omp_username;
<a name="l01192"></a>01192   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structserver__connection__t.html#a61a7e80906ce19c0dc25a92059bd62a1" title="Username with which to connect.">username</a> == NULL)
<a name="l01193"></a>01193     connection-&gt;<a class="code" href="structserver__connection__t.html#a61a7e80906ce19c0dc25a92059bd62a1" title="Username with which to connect.">username</a> = g_strdup (g_get_user_name ());
<a name="l01194"></a>01194 
<a name="l01195"></a>01195   <span class="keywordflow">if</span> (ping_timeout &lt; 0)
<a name="l01196"></a>01196     ping_timeout = <a class="code" href="omp_8c.html#ace11d8e3ed80e27635377d069a602788" title="Default timeout value for OMP pings.">DEFAULT_PING_TIMEOUT</a>;
<a name="l01197"></a>01197   connection-&gt;<a class="code" href="structserver__connection__t.html#a6445de8db03f5f8f91f2b68969683bc9" title="Timeout of request.">timeout</a> = ping_timeout;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199   <span class="keywordflow">if</span> (omp_password != NULL)
<a name="l01200"></a>01200     connection-&gt;<a class="code" href="structserver__connection__t.html#a41ecba5db56134f2c181f74619e25f91" title="Password for user with which to connect.">password</a> = omp_password;
<a name="l01201"></a>01201   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (connection-&gt;<a class="code" href="structserver__connection__t.html#a41ecba5db56134f2c181f74619e25f91" title="Password for user with which to connect.">password</a> == NULL &amp;&amp; !connection-&gt;<a class="code" href="structserver__connection__t.html#ad5a237f7f3aee0e0005e628c3587dfe6" title="Use client certificates to authenticate.">use_certs</a> &amp;&amp; !cmd_ping
<a name="l01202"></a>01202            &amp;&amp; !cmd_get_omp_version)
<a name="l01203"></a>01203     {
<a name="l01204"></a>01204       gchar *pw = NULL;
<a name="l01205"></a>01205       <span class="keywordtype">size_t</span> n;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207       printf (<span class="stringliteral">&quot;Enter password: &quot;</span>);
<a name="l01208"></a>01208       <span class="keywordtype">int</span> ret = <a class="code" href="omp_8c.html#a942946652df6b97b0b80eda4b5d77b89" title="Reads an entire line from a stream, suppressing character output.">read_password</a> (&amp;pw, &amp;n, stdin);
<a name="l01209"></a>01209       printf (<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01210"></a>01210 
<a name="l01211"></a>01211       <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l01212"></a>01212         {
<a name="l01213"></a>01213           fprintf (stderr, <span class="stringliteral">&quot;Failed to read password from console!\n&quot;</span>);
<a name="l01214"></a>01214           exit (EXIT_FAILURE);
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217       <span class="comment">/* Remove the trailing newline character. */</span>
<a name="l01218"></a>01218       pw[ret - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220       <span class="keywordflow">if</span> (strlen (pw) &gt; 0)
<a name="l01221"></a>01221         connection-&gt;<a class="code" href="structserver__connection__t.html#a41ecba5db56134f2c181f74619e25f91" title="Password for user with which to connect.">password</a> = pw;
<a name="l01222"></a>01222       <span class="keywordflow">else</span>
<a name="l01223"></a>01223         {
<a name="l01224"></a>01224           fprintf (stderr, <span class="stringliteral">&quot;Password must be set.\n&quot;</span>);
<a name="l01225"></a>01225           exit (EXIT_FAILURE);
<a name="l01226"></a>01226         }
<a name="l01227"></a>01227     }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229   <span class="keywordflow">if</span> (be_verbose)
<a name="l01230"></a>01230     {
<a name="l01231"></a>01231       <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l01232"></a>01232 
<a name="l01234"></a>01234       printf (<span class="stringliteral">&quot;\nWARNING: Verbose mode may reveal passwords!\n\n&quot;</span>);
<a name="l01235"></a>01235       printf (<span class="stringliteral">&quot;Will try to connect to host %s, port %d...\n&quot;</span>,
<a name="l01236"></a>01236               connection-&gt;<a class="code" href="structserver__connection__t.html#ad5f6fa44ac42acaa8333b5dfd00b094c" title="Server host string.">host_string</a>, connection-&gt;<a class="code" href="structserver__connection__t.html#aa2137ea29992e3851af1cf5e3c7f3887" title="Port of server.">port</a>);
<a name="l01237"></a>01237 
<a name="l01238"></a>01238       <span class="comment">/* Enable GNUTLS debugging if the envvar, as used by the</span>
<a name="l01239"></a>01239 <span class="comment">         standard log functions, is set.  */</span>
<a name="l01240"></a>01240       <span class="keywordflow">if</span> ((s=getenv (<span class="stringliteral">&quot;OPENVAS_GNUTLS_DEBUG&quot;</span>)))
<a name="l01241"></a>01241         {
<a name="l01242"></a>01242           gnutls_global_set_log_function (my_gnutls_log_func);
<a name="l01243"></a>01243           gnutls_global_set_log_level (atoi (s));
<a name="l01244"></a>01244         }
<a name="l01245"></a>01245     }
<a name="l01246"></a>01246   <span class="keywordflow">else</span>
<a name="l01247"></a>01247     {
<a name="l01248"></a>01248 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l01249"></a>01249 <span class="preprocessor"></span>      g_log_set_default_handler (openvas_log_silent, NULL);
<a name="l01250"></a>01250 <span class="preprocessor">#endif</span>
<a name="l01251"></a>01251 <span class="preprocessor"></span>    }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253   <span class="comment">/* Run the single command. */</span>
<a name="l01254"></a>01254 
<a name="l01255"></a>01255   <span class="keywordflow">if</span> (cmd_create_task)
<a name="l01256"></a>01256     {
<a name="l01257"></a>01257       <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = NULL;
<a name="l01258"></a>01258 
<a name="l01259"></a>01259       manager_open (connection);
<a name="l01260"></a>01260 
<a name="l01261"></a>01261       <span class="keywordflow">if</span> (omp_create_task
<a name="l01262"></a>01262           (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), name ? name : <span class="stringliteral">&quot;unnamed task&quot;</span>,
<a name="l01263"></a>01263            config ? config : <span class="stringliteral">&quot;Full and fast&quot;</span>, target ? target : <span class="stringliteral">&quot;Localhost&quot;</span>,
<a name="l01264"></a>01264            comment ? comment : <span class="stringliteral">&quot;&quot;</span>, &amp;<span class="keywordtype">id</span>))
<a name="l01265"></a>01265         {
<a name="l01266"></a>01266           fprintf (stderr, <span class="stringliteral">&quot;Failed to create task.\n&quot;</span>);
<a name="l01267"></a>01267           manager_close (connection);
<a name="l01268"></a>01268           exit (EXIT_FAILURE);
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271       printf (<span class="stringliteral">&quot;%s&quot;</span>, <span class="keywordtype">id</span>);
<a name="l01272"></a>01272       putchar (<span class="charliteral">&apos;\n&apos;</span>);
<a name="l01273"></a>01273 
<a name="l01274"></a>01274       manager_close (connection);
<a name="l01275"></a>01275       exit_status = 0;
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_delete_report)
<a name="l01278"></a>01278     {
<a name="l01279"></a>01279       gchar **point = rest;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281       <span class="keywordflow">if</span> (point == NULL || *point == NULL)
<a name="l01282"></a>01282         {
<a name="l01283"></a>01283           fprintf (stderr, <span class="stringliteral">&quot;delete-report requires at least one argument.\n&quot;</span>);
<a name="l01284"></a>01284           exit (EXIT_FAILURE);
<a name="l01285"></a>01285         }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287       manager_open (connection);
<a name="l01288"></a>01288 
<a name="l01289"></a>01289       <span class="keywordflow">while</span> (*point)
<a name="l01290"></a>01290         {
<a name="l01291"></a>01291           <span class="keywordflow">if</span> (omp_delete_report (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), *point))
<a name="l01292"></a>01292             {
<a name="l01293"></a>01293               fprintf (stderr, <span class="stringliteral">&quot;Failed to delete report %s, exiting.\n&quot;</span>,
<a name="l01294"></a>01294                        *point);
<a name="l01295"></a>01295               manager_close (connection);
<a name="l01296"></a>01296               exit (EXIT_FAILURE);
<a name="l01297"></a>01297             }
<a name="l01298"></a>01298           point++;
<a name="l01299"></a>01299         }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301       manager_close (connection);
<a name="l01302"></a>01302       exit_status = 0;
<a name="l01303"></a>01303     }
<a name="l01304"></a>01304   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_delete_task)
<a name="l01305"></a>01305     {
<a name="l01306"></a>01306       gchar **point = rest;
<a name="l01307"></a>01307 
<a name="l01308"></a>01308       <span class="keywordflow">if</span> (point == NULL || *point == NULL)
<a name="l01309"></a>01309         {
<a name="l01310"></a>01310           fprintf (stderr, <span class="stringliteral">&quot;delete-task requires at least one argument.\n&quot;</span>);
<a name="l01311"></a>01311           exit (EXIT_FAILURE);
<a name="l01312"></a>01312         }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314       manager_open (connection);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316       <span class="keywordflow">while</span> (*point)
<a name="l01317"></a>01317         {
<a name="l01318"></a>01318           <span class="keywordflow">if</span> (omp_delete_task (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), *point))
<a name="l01319"></a>01319             {
<a name="l01320"></a>01320               fprintf (stderr, <span class="stringliteral">&quot;Failed to delete task.\n&quot;</span>);
<a name="l01321"></a>01321               manager_close (connection);
<a name="l01322"></a>01322               exit (EXIT_FAILURE);
<a name="l01323"></a>01323             }
<a name="l01324"></a>01324           point++;
<a name="l01325"></a>01325         }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327       manager_close (connection);
<a name="l01328"></a>01328       exit_status = 0;
<a name="l01329"></a>01329     }
<a name="l01330"></a>01330   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_get_tasks)
<a name="l01331"></a>01331     {
<a name="l01332"></a>01332       gchar **point = rest;
<a name="l01333"></a>01333       entity_t status;
<a name="l01334"></a>01334 
<a name="l01335"></a>01335       manager_open (connection);
<a name="l01336"></a>01336 
<a name="l01337"></a>01337       <span class="keywordflow">if</span> (point)
<a name="l01338"></a>01338         <span class="keywordflow">while</span> (*point)
<a name="l01339"></a>01339           {
<a name="l01340"></a>01340             omp_get_task_opts_t opts;
<a name="l01341"></a>01341 
<a name="l01342"></a>01342             opts = omp_get_task_opts_defaults;
<a name="l01343"></a>01343             opts.task_id = *point;
<a name="l01344"></a>01344             opts.details = 1;
<a name="l01345"></a>01345             opts.actions = <span class="stringliteral">&quot;g&quot;</span>;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347             <span class="keywordflow">if</span> (omp_get_task_ext (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), opts, &amp;status))
<a name="l01348"></a>01348               {
<a name="l01349"></a>01349                 fprintf (stderr, <span class="stringliteral">&quot;Failed to get status of task %s.\n&quot;</span>, *point);
<a name="l01350"></a>01350                 manager_close (connection);
<a name="l01351"></a>01351                 exit (EXIT_FAILURE);
<a name="l01352"></a>01352               }
<a name="l01353"></a>01353             <span class="keywordflow">else</span>
<a name="l01354"></a>01354               {
<a name="l01355"></a>01355                 <span class="keywordflow">if</span> (print_tasks (status-&gt;entities))
<a name="l01356"></a>01356                   {
<a name="l01357"></a>01357                     manager_close (connection);
<a name="l01358"></a>01358                     exit (EXIT_FAILURE);
<a name="l01359"></a>01359                   }
<a name="l01360"></a>01360               }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362             point++;
<a name="l01363"></a>01363           }
<a name="l01364"></a>01364       <span class="keywordflow">else</span>
<a name="l01365"></a>01365         {
<a name="l01366"></a>01366           omp_get_tasks_opts_t opts;
<a name="l01367"></a>01367 
<a name="l01368"></a>01368           opts = omp_get_tasks_opts_defaults;
<a name="l01369"></a>01369           opts.details = 0;
<a name="l01370"></a>01370           opts.filter = <span class="stringliteral">&quot;permission=any owner=any rows=-1&quot;</span>;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372           <span class="keywordflow">if</span> (omp_get_tasks_ext (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), opts, &amp;status))
<a name="l01373"></a>01373             {
<a name="l01374"></a>01374               fprintf (stderr, <span class="stringliteral">&quot;Failed to get status of all tasks.\n&quot;</span>);
<a name="l01375"></a>01375               manager_close (connection);
<a name="l01376"></a>01376               exit (EXIT_FAILURE);
<a name="l01377"></a>01377             }
<a name="l01378"></a>01378           <span class="keywordflow">if</span> (print_tasks (status-&gt;entities))
<a name="l01379"></a>01379             {
<a name="l01380"></a>01380               manager_close (connection);
<a name="l01381"></a>01381               exit (EXIT_FAILURE);
<a name="l01382"></a>01382             }
<a name="l01383"></a>01383         }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385       manager_close (connection);
<a name="l01386"></a>01386       exit_status = 0;
<a name="l01387"></a>01387     }
<a name="l01388"></a>01388   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_get_configs)
<a name="l01389"></a>01389     {
<a name="l01390"></a>01390       entity_t status;
<a name="l01391"></a>01391 
<a name="l01392"></a>01392       manager_open (connection);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394       <span class="keywordflow">if</span> (<a class="code" href="omp_8c.html#a6494b5459d38159e9d40bc4fa05b69e3" title="Get the list of scan configs.">get_configs</a> (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), &amp;status))
<a name="l01395"></a>01395         {
<a name="l01396"></a>01396           fprintf (stderr, <span class="stringliteral">&quot;Failed to get configs.\n&quot;</span>);
<a name="l01397"></a>01397           exit (EXIT_FAILURE);
<a name="l01398"></a>01398         }
<a name="l01399"></a>01399       <span class="keywordflow">if</span> (print_configs (status-&gt;entities))
<a name="l01400"></a>01400         {
<a name="l01401"></a>01401           manager_close (connection);
<a name="l01402"></a>01402           exit (EXIT_FAILURE);
<a name="l01403"></a>01403         }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405       manager_close (connection);
<a name="l01406"></a>01406       exit_status = 0;
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_get_targets)
<a name="l01409"></a>01409     {
<a name="l01410"></a>01410       entity_t status;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412       manager_open (connection);
<a name="l01413"></a>01413 
<a name="l01414"></a>01414       <span class="keywordflow">if</span> (omp_get_targets (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), NULL, 0, 0, &amp;status))
<a name="l01415"></a>01415         {
<a name="l01416"></a>01416           fprintf (stderr, <span class="stringliteral">&quot;Failed to get targets.\n&quot;</span>);
<a name="l01417"></a>01417           exit (EXIT_FAILURE);
<a name="l01418"></a>01418         }
<a name="l01419"></a>01419       <span class="keywordflow">if</span> (print_targets (status-&gt;entities))
<a name="l01420"></a>01420         {
<a name="l01421"></a>01421           manager_close (connection);
<a name="l01422"></a>01422           exit (EXIT_FAILURE);
<a name="l01423"></a>01423         }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425       manager_close (connection);
<a name="l01426"></a>01426       exit_status = 0;
<a name="l01427"></a>01427     }
<a name="l01428"></a>01428   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_get_report)
<a name="l01429"></a>01429     {
<a name="l01430"></a>01430       gchar **report_ids = rest;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432       <span class="keywordflow">if</span> (report_ids == NULL || *report_ids == NULL)
<a name="l01433"></a>01433         {
<a name="l01434"></a>01434           fprintf (stderr, <span class="stringliteral">&quot;get-report requires one argument.\n&quot;</span>);
<a name="l01435"></a>01435           exit (EXIT_FAILURE);
<a name="l01436"></a>01436         }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438       manager_open (connection);
<a name="l01439"></a>01439       exit_status = manager_get_reports (connection, report_ids, format);
<a name="l01440"></a>01440       <span class="keywordflow">if</span> (exit_status == 0)
<a name="l01441"></a>01441         manager_close (connection);
<a name="l01442"></a>01442     }
<a name="l01443"></a>01443   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_get_report_formats)
<a name="l01444"></a>01444     {
<a name="l01445"></a>01445       manager_open (connection);
<a name="l01446"></a>01446       exit_status = manager_get_report_formats (connection);
<a name="l01447"></a>01447       <span class="keywordflow">if</span> (exit_status == 0)
<a name="l01448"></a>01448         manager_close (connection);
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_get_omp_version)
<a name="l01451"></a>01451     {
<a name="l01452"></a>01452       gchar *version = NULL;
<a name="l01453"></a>01453       manager_open (connection);
<a name="l01454"></a>01454       exit_status = manager_get_omp_version (connection, &amp;version);
<a name="l01455"></a>01455       printf (<span class="stringliteral">&quot;Version: %s\n&quot;</span>, version);
<a name="l01456"></a>01456       g_free (version);
<a name="l01457"></a>01457       <span class="keywordflow">if</span> (exit_status == 0)
<a name="l01458"></a>01458         manager_close (connection);
<a name="l01459"></a>01459     }
<a name="l01460"></a>01460   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_ping)
<a name="l01461"></a>01461     {
<a name="l01462"></a>01462       <span class="keywordflow">if</span> (manager_open (connection))
<a name="l01463"></a>01463         {
<a name="l01464"></a>01464           fprintf (stderr, <span class="stringliteral">&quot;OMP ping failed: Failed to establish connection.\n&quot;</span>);
<a name="l01465"></a>01465           exit_status = 1;
<a name="l01466"></a>01466         }
<a name="l01467"></a>01467       <span class="keywordflow">else</span>
<a name="l01468"></a>01468         {
<a name="l01469"></a>01469           <span class="keywordtype">int</span> res;
<a name="l01470"></a>01470           <span class="comment">/* Returns 0 on success, 1 if manager closed connection, 2 on</span>
<a name="l01471"></a>01471 <span class="comment">             timeout, -1 on error */</span>
<a name="l01472"></a>01472           res = omp_ping (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), connection-&gt;<a class="code" href="structserver__connection__t.html#a6445de8db03f5f8f91f2b68969683bc9" title="Timeout of request.">timeout</a>);
<a name="l01473"></a>01473           <span class="keywordflow">if</span> (res == 0)
<a name="l01474"></a>01474             {
<a name="l01475"></a>01475               fprintf (stdout, <span class="stringliteral">&quot;OMP ping was successful.\n&quot;</span>);
<a name="l01476"></a>01476               exit_status = 0;
<a name="l01477"></a>01477             }
<a name="l01478"></a>01478           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 1)
<a name="l01479"></a>01479             {
<a name="l01480"></a>01480               fprintf (stderr, <span class="stringliteral">&quot;OMP ping failed: Server closed connection.\n&quot;</span>);
<a name="l01481"></a>01481               exit_status = 1;
<a name="l01482"></a>01482             }
<a name="l01483"></a>01483           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == 2)
<a name="l01484"></a>01484             {
<a name="l01485"></a>01485               fprintf (stderr, <span class="stringliteral">&quot;OMP ping failed: Timeout.\n&quot;</span>);
<a name="l01486"></a>01486               exit_status = 1;
<a name="l01487"></a>01487             }
<a name="l01488"></a>01488           <span class="keywordflow">else</span>
<a name="l01489"></a>01489             {
<a name="l01490"></a>01490               fprintf (stderr, <span class="stringliteral">&quot;OMP ping failed: Unknown error.\n&quot;</span>);
<a name="l01491"></a>01491               exit_status = 1;
<a name="l01492"></a>01492             }
<a name="l01493"></a>01493         }
<a name="l01494"></a>01494       <span class="keywordflow">if</span> (exit_status == 0)
<a name="l01495"></a>01495         manager_close (connection);
<a name="l01496"></a>01496     }
<a name="l01497"></a>01497   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_modify_task)
<a name="l01498"></a>01498     {
<a name="l01499"></a>01499       gchar **point = rest;
<a name="l01500"></a>01500       gchar *content;
<a name="l01501"></a>01501       gsize content_len;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503       <span class="keywordflow">if</span> (point == NULL || *point == NULL)
<a name="l01504"></a>01504         {
<a name="l01505"></a>01505           fprintf (stderr, <span class="stringliteral">&quot;modify-task requires one argument.\n&quot;</span>);
<a name="l01506"></a>01506           exit (EXIT_FAILURE);
<a name="l01507"></a>01507         }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       <span class="keywordflow">if</span> (name == NULL)
<a name="l01510"></a>01510         {
<a name="l01511"></a>01511           fprintf (stderr,
<a name="l01512"></a>01512                    <span class="stringliteral">&quot;modify-task requires the name option (path to file).\n&quot;</span>);
<a name="l01513"></a>01513           exit (EXIT_FAILURE);
<a name="l01514"></a>01514         }
<a name="l01515"></a>01515 
<a name="l01516"></a>01516       <span class="keywordflow">if</span> (file == FALSE)
<a name="l01517"></a>01517         {
<a name="l01518"></a>01518           fprintf (stderr, <span class="stringliteral">&quot;modify-task requires the file option.\n&quot;</span>);
<a name="l01519"></a>01519           exit (EXIT_FAILURE);
<a name="l01520"></a>01520         }
<a name="l01521"></a>01521 
<a name="l01522"></a>01522       <span class="keywordflow">if</span> (file)
<a name="l01523"></a>01523         {
<a name="l01524"></a>01524           GIOChannel *stdin_channel;
<a name="l01525"></a>01525           manager_open (connection);
<a name="l01526"></a>01526 
<a name="l01527"></a>01527           <span class="comment">/* Mixing stream and file descriptor IO might lead to trouble. */</span>
<a name="l01528"></a>01528           error = NULL;
<a name="l01529"></a>01529           stdin_channel = g_io_channel_unix_new (fileno (stdin));
<a name="l01530"></a>01530           g_io_channel_read_to_end (stdin_channel, &amp;content, &amp;content_len,
<a name="l01531"></a>01531                                     &amp;error);
<a name="l01532"></a>01532           g_io_channel_shutdown (stdin_channel, TRUE, NULL);
<a name="l01533"></a>01533           g_io_channel_unref (stdin_channel);
<a name="l01534"></a>01534           <span class="keywordflow">if</span> (error)
<a name="l01535"></a>01535             {
<a name="l01536"></a>01536               fprintf (stderr, <span class="stringliteral">&quot;failed to read from stdin: %s\n&quot;</span>,
<a name="l01537"></a>01537                        error-&gt;message);
<a name="l01538"></a>01538               g_error_free (error);
<a name="l01539"></a>01539               exit (EXIT_FAILURE);
<a name="l01540"></a>01540             }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542 <span class="preprocessor">#if 0</span>
<a name="l01543"></a>01543 <span class="preprocessor"></span>
<a name="l01544"></a>01544           exit_status =
<a name="l01545"></a>01545             manager_modify_task_file (connection, *point, name, content,
<a name="l01546"></a>01546                                       content_len, error);
<a name="l01547"></a>01547 <span class="preprocessor">#else</span>
<a name="l01548"></a>01548 <span class="preprocessor"></span>          <span class="keywordflow">if</span> (omp_modify_task_file
<a name="l01549"></a>01549               (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), *point, name, content, content_len))
<a name="l01550"></a>01550             {
<a name="l01551"></a>01551               g_free (content);
<a name="l01552"></a>01552               fprintf (stderr, <span class="stringliteral">&quot;Failed to modify task.\n&quot;</span>);
<a name="l01553"></a>01553               manager_close (connection);
<a name="l01554"></a>01554               exit (EXIT_FAILURE);
<a name="l01555"></a>01555             }
<a name="l01556"></a>01556 
<a name="l01557"></a>01557           manager_close (connection);
<a name="l01558"></a>01558           exit_status = 0;
<a name="l01559"></a>01559 <span class="preprocessor">#endif</span>
<a name="l01560"></a>01560 <span class="preprocessor"></span>        }
<a name="l01561"></a>01561     }
<a name="l01562"></a>01562   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_start_task)
<a name="l01563"></a>01563     {
<a name="l01564"></a>01564       gchar **point = rest;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566       <span class="keywordflow">if</span> (point == NULL || *point == NULL)
<a name="l01567"></a>01567         {
<a name="l01568"></a>01568           fprintf (stderr, <span class="stringliteral">&quot;start-task requires at least one argument.\n&quot;</span>);
<a name="l01569"></a>01569           exit (EXIT_FAILURE);
<a name="l01570"></a>01570         }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572       manager_open (connection);
<a name="l01573"></a>01573 
<a name="l01574"></a>01574       <span class="keywordflow">while</span> (*point)
<a name="l01575"></a>01575         {
<a name="l01576"></a>01576           <span class="keywordtype">char</span> *report_id;
<a name="l01577"></a>01577           <span class="keywordflow">if</span> (omp_start_task_report
<a name="l01578"></a>01578               (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), *point, &amp;report_id))
<a name="l01579"></a>01579             {
<a name="l01580"></a>01580               fprintf (stderr, <span class="stringliteral">&quot;Failed to start task.\n&quot;</span>);
<a name="l01581"></a>01581               manager_close (connection);
<a name="l01582"></a>01582               exit (EXIT_FAILURE);
<a name="l01583"></a>01583             }
<a name="l01584"></a>01584           printf (<span class="stringliteral">&quot;%s\n&quot;</span>, report_id);
<a name="l01585"></a>01585           free (report_id);
<a name="l01586"></a>01586           point++;
<a name="l01587"></a>01587         }
<a name="l01588"></a>01588       exit_status = 0;
<a name="l01589"></a>01589 
<a name="l01590"></a>01590       manager_close (connection);
<a name="l01591"></a>01591     }
<a name="l01592"></a>01592   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd_xml)
<a name="l01593"></a>01593     {
<a name="l01594"></a>01594       manager_open (connection);
<a name="l01595"></a>01595 
<a name="l01596"></a>01596       <span class="keywordflow">if</span> (send_file_path)
<a name="l01597"></a>01597         {
<a name="l01598"></a>01598           <span class="keywordtype">char</span> *new_xml = cmd_xml;
<a name="l01599"></a>01599           <span class="keywordflow">if</span> (replace_send_file_xml (&amp;new_xml, send_file_path))
<a name="l01600"></a>01600             exit (EXIT_FAILURE);
<a name="l01601"></a>01601           g_free (cmd_xml);
<a name="l01602"></a>01602           cmd_xml = new_xml;
<a name="l01603"></a>01603         }
<a name="l01604"></a>01604 
<a name="l01606"></a>01606       <span class="keywordflow">if</span> (prompt)
<a name="l01607"></a>01607         {
<a name="l01608"></a>01608           fprintf (stderr, <span class="stringliteral">&quot;Connected, press a key to continue.\n&quot;</span>);
<a name="l01609"></a>01609           getchar ();
<a name="l01610"></a>01610         }
<a name="l01611"></a>01611 
<a name="l01612"></a>01612       <span class="keywordflow">if</span> (strcmp (cmd_xml, <span class="stringliteral">&quot;-&quot;</span>) == 0)
<a name="l01613"></a>01613         {
<a name="l01614"></a>01614           GError *error;
<a name="l01615"></a>01615           gchar *content;
<a name="l01616"></a>01616           gsize content_len;
<a name="l01617"></a>01617           GIOChannel *stdin_channel;
<a name="l01618"></a>01618 
<a name="l01619"></a>01619           <span class="comment">/* Mixing stream and file descriptor IO might lead to trouble. */</span>
<a name="l01620"></a>01620           error = NULL;
<a name="l01621"></a>01621           stdin_channel = g_io_channel_unix_new (fileno (stdin));
<a name="l01622"></a>01622           g_io_channel_read_to_end (stdin_channel, &amp;content, &amp;content_len,
<a name="l01623"></a>01623                                     &amp;error);
<a name="l01624"></a>01624           g_io_channel_shutdown (stdin_channel, TRUE, NULL);
<a name="l01625"></a>01625           g_io_channel_unref (stdin_channel);
<a name="l01626"></a>01626           <span class="keywordflow">if</span> (error)
<a name="l01627"></a>01627             {
<a name="l01628"></a>01628               fprintf (stderr, <span class="stringliteral">&quot;Failed to read from stdin: %s\n&quot;</span>,
<a name="l01629"></a>01629                        error-&gt;message);
<a name="l01630"></a>01630               g_error_free (error);
<a name="l01631"></a>01631               exit (EXIT_FAILURE);
<a name="l01632"></a>01632             }
<a name="l01633"></a>01633 
<a name="l01634"></a>01634           g_free (cmd_xml);
<a name="l01635"></a>01635           cmd_xml = content;
<a name="l01636"></a>01636         }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638       <span class="keywordflow">if</span> (be_verbose)
<a name="l01639"></a>01639         printf (<span class="stringliteral">&quot;Sending to manager: %s\n&quot;</span>, cmd_xml);
<a name="l01640"></a>01640 
<a name="l01641"></a>01641       <span class="keywordflow">if</span> (openvas_server_send (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), cmd_xml) == -1)
<a name="l01642"></a>01642         {
<a name="l01643"></a>01643           manager_close (connection);
<a name="l01644"></a>01644           fprintf (stderr, <span class="stringliteral">&quot;Failed to send_to_manager.\n&quot;</span>);
<a name="l01645"></a>01645           exit (EXIT_FAILURE);
<a name="l01646"></a>01646         }
<a name="l01647"></a>01647 
<a name="l01648"></a>01648       <span class="comment">/* Read the response. */</span>
<a name="l01649"></a>01649 
<a name="l01650"></a>01650       entity_t entity = NULL;
<a name="l01651"></a>01651       <span class="keywordflow">if</span> (read_entity (&amp;(connection-&gt;<a class="code" href="structserver__connection__t.html#aca291023ee7ec263d6e4e544ed0786d8" title="GnuTLS Session to use.">session</a>), &amp;entity))
<a name="l01652"></a>01652         {
<a name="l01653"></a>01653           fprintf (stderr, <span class="stringliteral">&quot;Failed to read response.\n&quot;</span>);
<a name="l01654"></a>01654           manager_close (connection);
<a name="l01655"></a>01655           exit (EXIT_FAILURE);
<a name="l01656"></a>01656         }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658       <span class="keywordflow">if</span> (be_verbose)
<a name="l01659"></a>01659         printf (<span class="stringliteral">&quot;Got response:\n&quot;</span>);
<a name="l01660"></a>01660       <span class="keywordflow">if</span> (pretty_print == FALSE)
<a name="l01661"></a>01661         print_entity (stdout, entity);
<a name="l01662"></a>01662       <span class="keywordflow">else</span>
<a name="l01663"></a>01663         print_entity_format (entity, GINT_TO_POINTER (2));
<a name="l01664"></a>01664       printf (<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01665"></a>01665 
<a name="l01666"></a>01666       <span class="comment">/* Cleanup. */</span>
<a name="l01667"></a>01667 
<a name="l01669"></a>01669       <span class="keywordflow">if</span> (prompt)
<a name="l01670"></a>01670         {
<a name="l01671"></a>01671           fprintf (stderr, <span class="stringliteral">&quot;Press a key when done.\n&quot;</span>);
<a name="l01672"></a>01672           getchar ();
<a name="l01673"></a>01673         }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675       manager_close (connection);
<a name="l01676"></a>01676       free_entity (entity);
<a name="l01677"></a>01677 
<a name="l01678"></a>01678       exit_status = 0;
<a name="l01679"></a>01679     }
<a name="l01680"></a>01680   <span class="keywordflow">else</span>
<a name="l01681"></a>01681     <span class="comment">/* The option processing ensures that at least one command is present. */</span>
<a name="l01682"></a>01682     assert (0);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684   <span class="comment">/* Exit. */</span>
<a name="l01685"></a>01685 
<a name="l01686"></a>01686   <span class="keywordflow">if</span> (be_verbose)
<a name="l01687"></a>01687     {
<a name="l01688"></a>01688       <span class="keywordflow">if</span> (exit_status)
<a name="l01689"></a>01689         printf (<span class="stringliteral">&quot;Command failed.\n&quot;</span>);
<a name="l01690"></a>01690       <span class="keywordflow">else</span>
<a name="l01691"></a>01691         printf (<span class="stringliteral">&quot;Command completed successfully.\n&quot;</span>);
<a name="l01692"></a>01692     }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694   exit (exit_status);
<a name="l01695"></a>01695 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
<a class="anchor" id="a942946652df6b97b0b80eda4b5d77b89"></a><!-- doxytag: member="omp.c::read_password" ref="a942946652df6b97b0b80eda4b5d77b89" args="(char **lineptr, size_t *n, FILE *stream)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ssize_t read_password </td>
          <td>(</td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>lineptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *&nbsp;</td>
          <td class="paramname"> <em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>stream</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reads an entire line from a stream, suppressing character output. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>lineptr</em>&nbsp;</td><td>Location of the buffer where the line is stored. </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>n</em>&nbsp;</td><td>Size of allocated buffer in lineptr is not null. </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>stream</em>&nbsp;</td><td>Stream from which the line should be read.</td></tr>
  </table>
  </dd>
</dl>
<p>This function mimics the behaviour of getline (). Please see the man page of getline () for additional information about the parameters. This function was taken from the example provided in the GNU C Library, for example at <a href="http://www.gnu.org/s/libc/manual/html_node/getpass.html.">http://www.gnu.org/s/libc/manual/html_node/getpass.html.</a></p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>Move this function to openvas-libraries since openvas-administrator uses it as well. </dd></dl>

<p>Definition at line <a class="el" href="omp_8c_source.html#l00818">818</a> of file <a class="el" href="omp_8c_source.html">omp.c</a>.</p>

<p>Referenced by <a class="el" href="omp_8c_source.html#l00958">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00819"></a>00819 {
<a name="l00820"></a>00820   <span class="keyword">struct </span>termios old, new;
<a name="l00821"></a>00821   <span class="keywordtype">int</span> nread;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823   <span class="comment">/* Turn echoing off and fail if we can&apos;t. */</span>
<a name="l00824"></a>00824   <span class="keywordflow">if</span> (tcgetattr (fileno (stream), &amp;old) != 0)
<a name="l00825"></a>00825     <span class="keywordflow">return</span> -1;
<a name="l00826"></a>00826   <span class="keyword">new</span> = old;
<a name="l00827"></a>00827   <span class="keyword">new</span>.c_lflag &amp;= ~ECHO;
<a name="l00828"></a>00828   <span class="keywordflow">if</span> (tcsetattr (fileno (stream), TCSAFLUSH, &amp;<span class="keyword">new</span>) != 0)
<a name="l00829"></a>00829     <span class="keywordflow">return</span> -1;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831   <span class="comment">/* Read the password. */</span>
<a name="l00832"></a>00832   nread = getline (lineptr, n, stream);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   <span class="comment">/* Restore terminal. */</span>
<a name="l00835"></a>00835   (void) tcsetattr (fileno (stream), TCSAFLUSH, &amp;old);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837   <span class="keywordflow">return</span> nread;
<a name="l00838"></a>00838 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>
</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 23 Oct 2015 for OpenVAS CLI by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
